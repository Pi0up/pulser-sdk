/*! Pulser SDK v0.1.0 (c) Pulser Labs */
var PulserSDK=function(){"use strict";class e{static debugMode=!1;static wrap(n,t="SDK"){return async(...s)=>{try{return await n(...s)}catch(i){return e.log(i,t),null}}}static log(n,t){(e.debugMode||"localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname)&&console.warn(`[PulserSDK - ${t}]`,n)}static enableDebug(){e.debugMode=!0,console.log("[PulserSDK] Debug mode enabled")}static disableDebug(){e.debugMode=!1}}class n{constructor(){this.prefix="pulser_sdk_",this.keys={userMeta:`${this.prefix}user_meta`,campaignHistory:`${this.prefix}campaign_history`,answeredQuestions:`${this.prefix}answered_questions`,configCache:`${this.prefix}config_cache`,configLastFetch:`${this.prefix}config_last_fetch`,consent:`${this.prefix}consent`}}_sanitizeValue(e,n=null){if(n||(n=new WeakSet),null==e)return e;if("object"!=typeof e)return e;if(e instanceof Element||e instanceof Node)return`[DOM Element: ${e.nodeName}]`;if(e===window||e===document)return"[Window/Document]";if(n.has(e))return"[Circular Reference]";if(n.add(e),Array.isArray(e))return e.map(e=>this._sanitizeValue(e,n));const t={};for(const i in e)if(e.hasOwnProperty(i))try{if("function"==typeof e[i])continue;t[i]=this._sanitizeValue(e[i],n)}catch(s){t[i]="[Unable to serialize]"}return t}setUserData(n,t){try{const s=this.getAllUserData(),i=this._sanitizeValue(t);s[n]=i;const a=this._sanitizeValue(s);localStorage.setItem(this.keys.userMeta,JSON.stringify(a)),e.debugMode&&console.log("[StorageManager] User data saved (sanitized):",{key:n,value:i})}catch(s){e.log(s,"StorageManager.setUserData")}}getAllUserData(){try{const e=localStorage.getItem(this.keys.userMeta);return e?JSON.parse(e):{}}catch(n){return e.log(n,"StorageManager.getAllUserData"),{}}}getCampaignHistory(n){try{return this._getAllCampaignHistory()[n]||null}catch(t){return e.log(t,"StorageManager.getCampaignHistory"),null}}markCampaignAsShown(n,t){try{const s=this._getAllCampaignHistory(),i=Date.now();s[n]?(s[n].lastShown=i,s[n].shownCount+=1,s[n].lastQuestionId=t):s[n]={firstShown:i,lastShown:i,shownCount:1,dismissedCount:0,answeredCount:0,lastQuestionId:t};const a=this._sanitizeValue(s);localStorage.setItem(this.keys.campaignHistory,JSON.stringify(a)),e.debugMode&&console.log("[StorageManager] Campaign marked as shown:",{campaignId:n,questionId:t})}catch(s){e.log(s,"StorageManager.markCampaignAsShown")}}markCampaignAsDismissed(n){try{const t=this._getAllCampaignHistory();t[n]&&(t[n].dismissedCount+=1,t[n].lastShown=Date.now());const s=this._sanitizeValue(t);localStorage.setItem(this.keys.campaignHistory,JSON.stringify(s)),e.debugMode&&console.log("[StorageManager] Campaign marked as dismissed:",n)}catch(t){e.log(t,"StorageManager.markCampaignAsDismissed")}}markCampaignAsAnswered(n,t){try{const s=this._getAllCampaignHistory();s[n]&&(s[n].answeredCount+=1,s[n].lastShown=Date.now());const i=this._sanitizeValue(s);localStorage.setItem(this.keys.campaignHistory,JSON.stringify(i)),this._storeAnsweredQuestion(n,t),e.debugMode&&console.log("[StorageManager] Campaign marked as answered:",{campaignId:n,questionId:t})}catch(s){e.log(s,"StorageManager.markCampaignAsAnswered")}}canShowCampaign(n,t){if(0===t)return!0;try{const s=this.getCampaignHistory(n);if(!s||!s.lastShown)return!0;const i=(Date.now()-s.lastShown)/864e5,a=i>=t;return e.debugMode&&console.log("[StorageManager] Can show campaign?",{campaignId:n,daysSinceLastShown:i.toFixed(2),frequencyDays:t,canShow:a}),a}catch(s){return e.log(s,"StorageManager.canShowCampaign"),!0}}_getAllCampaignHistory(){try{const e=localStorage.getItem(this.keys.campaignHistory);return e?JSON.parse(e):{}}catch(n){return e.log(n,"StorageManager._getAllCampaignHistory"),{}}}_storeAnsweredQuestion(n,t){try{const s=this._getAllAnsweredQuestions();s[`${n}:${t}`]=Date.now();const i=this._sanitizeValue(s);localStorage.setItem(this.keys.answeredQuestions,JSON.stringify(i)),e.debugMode&&console.log("[StorageManager] Question stored as answered:",{campaignId:n,questionId:t})}catch(s){e.log(s,"StorageManager._storeAnsweredQuestion")}}hasAnswered(n,t){try{const e=this._getAllAnsweredQuestions();return void 0!==e[`${n}:${t}`]}catch(s){return e.log(s,"StorageManager.hasAnswered"),!1}}_getAllAnsweredQuestions(){try{const e=localStorage.getItem(this.keys.answeredQuestions);return e?JSON.parse(e):{}}catch(n){return e.log(n,"StorageManager._getAllAnsweredQuestions"),{}}}setCachedConfig(n){try{const t=this._sanitizeValue(n);localStorage.setItem(this.keys.configCache,JSON.stringify(t)),localStorage.setItem(this.keys.configLastFetch,Date.now().toString()),e.debugMode&&console.log("[StorageManager] Config cached")}catch(t){e.log(t,"StorageManager.setCachedConfig")}}getCachedConfig(){try{const e=localStorage.getItem(this.keys.configCache);return e?JSON.parse(e):null}catch(n){return e.log(n,"StorageManager.getCachedConfig"),null}}getLastFetchDate(){try{const e=localStorage.getItem(this.keys.configLastFetch);return e?parseInt(e,10):null}catch(n){return e.log(n,"StorageManager.getLastFetchDate"),null}}isCacheValid(e){const n=this.getLastFetchDate();if(!n)return!1;return Date.now()-n<e}getConsent(){try{const e=localStorage.getItem(this.keys.consent);return null===e?null:"true"===e}catch(n){return e.log(n,"StorageManager.getConsent"),null}}setConsent(n){try{localStorage.setItem(this.keys.consent,n.toString()),e.debugMode&&console.log("[StorageManager] Consent saved:",n)}catch(t){e.log(t,"StorageManager.setConsent")}}clearConsent(){try{localStorage.removeItem(this.keys.consent),e.debugMode&&console.log("[StorageManager] Consent cleared")}catch(n){e.log(n,"StorageManager.clearConsent")}}clearAllResponses(){try{localStorage.removeItem(this.keys.answeredQuestions),e.debugMode&&console.log("[StorageManager] All responses cleared")}catch(n){e.log(n,"StorageManager.clearAllResponses")}}clearAllImpressions(){try{localStorage.removeItem(this.keys.campaignHistory),e.debugMode&&console.log("[StorageManager] All impressions cleared")}catch(n){e.log(n,"StorageManager.clearAllImpressions")}}clearAll(){try{Object.values(this.keys).forEach(e=>{localStorage.removeItem(e)}),e.debugMode&&console.log("[StorageManager] All data cleared")}catch(n){e.log(n,"StorageManager.clearAll")}}}class t{constructor(e,n,t,s){this.domain=e,this.language=n,this.specificId=t,this.storageManager=s,this.apiBaseUrl=`https://api.${e}/feedback`}async fetchConfig(n=!1){try{if(n)e.debugMode&&console.log("[ConfigManager] Force refresh requested, ignoring cache");else{const n=this.storageManager.getCachedConfig(),t=n?.cacheTTL||864e5;if(n&&this.storageManager.isCacheValid(t))return e.debugMode&&console.log("[ConfigManager] Using cached config"),n}e.debugMode&&console.log("[ConfigManager] Fetching config from API");const t=await this._fetchFromAPI(n);if(t)return this.storageManager.setCachedConfig(t),t;const s=this.storageManager.getCachedConfig();return s?(e.debugMode&&console.log("[ConfigManager] Using expired cache as fallback"),s):{campaigns:[],consent:null}}catch(t){e.log(t,"ConfigManager.fetchConfig");return this.storageManager.getCachedConfig()||{campaigns:[],consent:null}}}async fetchCampaigns(e=!1){return(await this.fetchConfig(e)).campaigns||[]}async _fetchFromAPI(n=!1){try{const t=this._buildApiUrl(),s=this._buildHeaders(n);e.debugMode&&console.log("[ConfigManager] Fetching:",{url:t,headers:s});const i=await fetch(t,{method:"GET",headers:s,cache:"no-cache"});if(304===i.status){e.debugMode&&console.log("[ConfigManager] Config not modified (304)");return this.storageManager.getCachedConfig()}if(i.ok){const n=await i.json();return e.debugMode&&console.log("[ConfigManager] Config fetched successfully:",{campaignsCount:n.campaigns?.length||0}),n}return console.warn("[ConfigManager] API responded with status:",i.status),null}catch(t){return e.log(t,"ConfigManager._fetchFromAPI"),null}}_buildApiUrl(){let e=`${this.apiBaseUrl}/config?lang=${this.language}`;return this.specificId&&(e+=`&id=${this.specificId}`),e}_buildHeaders(e=!1){const n={"Content-Type":"application/json",Accept:"application/json"};if(!e){const e=this.storageManager.getLastFetchDate();e&&(n["X-Last-Fetch-Date"]=e.toString())}return n}}class s{constructor(e){this.storageManager=e}findEligibleCampaign(n,t){try{const s=Date.now();e.debugMode&&console.log("[DecisionEngine] Evaluating campaigns:",{campaignsCount:n.length,currentUrl:t});const i=n.filter(n=>{const t=s>=n.startDate&&s<=n.endDate;return e.debugMode&&!t&&console.log("[DecisionEngine] Campaign not active:",{id:n.id,startDate:new Date(n.startDate).toISOString(),endDate:new Date(n.endDate).toISOString()}),t});if(0===i.length)return e.debugMode&&console.log("[DecisionEngine] No active campaigns"),null;const a=i.filter(e=>this._isUrlEligible(e,t));if(0===a.length)return e.debugMode&&console.log("[DecisionEngine] No campaigns match URL filters"),null;const o=a.filter(e=>this.storageManager.canShowCampaign(e.id,e.frequencyDays||0));if(0===o.length)return e.debugMode&&console.log("[DecisionEngine] No campaigns pass frequency check"),null;const r=o.sort((e,n)=>(n.priority||0)-(e.priority||0));for(const n of r){const t=void 0!==n.luckFactor?n.luckFactor:1,s=Math.random();if(e.debugMode&&console.log("[DecisionEngine] Testing campaign luck:",{campaignId:n.id,luckFactor:t,random:s.toFixed(3),passes:s<=t}),s<=t){const t=this._selectQuestionFromCampaign(n);if(t)return e.debugMode&&console.log("[DecisionEngine] Campaign selected:",{campaignId:n.id,questionId:t.id}),{campaign:n,question:t}}}return e.debugMode&&console.log("[DecisionEngine] No campaign passed luck factor"),null}catch(s){return e.log(s,"DecisionEngine.findEligibleCampaign"),null}}_isUrlEligible(n,t){try{const s=new URL(t).pathname;if(n.blockListRegex&&n.blockListRegex.length>0)for(const t of n.blockListRegex){if(new RegExp(t).test(s))return e.debugMode&&console.log("[DecisionEngine] URL blocked by campaign:",{campaignId:n.id,pattern:t,path:s}),!1}if(n.allowListRegex&&n.allowListRegex.length>0){for(const e of n.allowListRegex){if(new RegExp(e).test(s))return!0}return e.debugMode&&console.log("[DecisionEngine] URL not in allowList for campaign:",{campaignId:n.id,path:s}),!1}return!0}catch(s){return e.log(s,"DecisionEngine._isUrlEligible"),!1}}_selectQuestionFromCampaign(n){try{if(!n.questions||0===n.questions.length)return e.debugMode&&console.log("[DecisionEngine] Campaign has no questions:",n.id),null;const t=n.questions.filter(t=>{const s=this.storageManager.hasAnswered(n.id,t.id);return s&&e.debugMode&&console.log("[DecisionEngine] Question already answered, skipping:",{campaignId:n.id,questionId:t.id}),!s});if(0===t.length)return e.debugMode&&console.log("[DecisionEngine] All questions answered for campaign:",n.id),null;const s=t[Math.floor(Math.random()*t.length)];return e.debugMode&&console.log("[DecisionEngine] Question selected:",{campaignId:n.id,questionId:s.id,totalQuestions:n.questions.length,unansweredQuestions:t.length}),s}catch(t){return e.log(t,"DecisionEngine._selectQuestionFromCampaign"),null}}}class i{constructor(e){this.domain=e,this.apiBaseUrl=`https://api.${e}/feedback`}_sanitizeData(e,n=null){if(n||(n=new WeakSet),null==e)return e;if("object"!=typeof e)return e;if(e instanceof Element||e instanceof Node)return`[DOM Element: ${e.nodeName}]`;if(e===window||e===document)return"[Window/Document]";if(n.has(e))return"[Circular Reference]";if(n.add(e),Array.isArray(e))return e.map(e=>this._sanitizeData(e,n));const t={};for(const i in e)if(e.hasOwnProperty(i))try{const s=e[i];if("function"==typeof s)continue;t[i]=this._sanitizeData(s,n)}catch(s){t[i]="[Unable to serialize]"}return t}async submitAnswer(n,t,s,i={}){try{const a={campaignId:n,questionId:t,answer:s,metadata:this._sanitizeData(i),timestamp:Date.now(),url:window.location.href,userAgent:navigator.userAgent},o=this._sanitizeData(a);e.debugMode&&console.log("[DataSubmitter] Submitting answer:",o);const r=await fetch(`${this.apiBaseUrl}/submit`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)});return r.ok?(e.debugMode&&console.log("[DataSubmitter] Answer submitted successfully"),!0):(console.warn("[DataSubmitter] Submit failed with status:",r.status),!1)}catch(a){return e.log(a,"DataSubmitter.submitAnswer"),!1}}async submitImpression(n,t,s={}){try{const i={campaignId:n,questionId:t,metadata:this._sanitizeData(s),timestamp:Date.now(),url:window.location.href,userAgent:navigator.userAgent},a=this._sanitizeData(i);e.debugMode&&console.log("[DataSubmitter] Submitting impression:",a);const o=await fetch(`${this.apiBaseUrl}/impression`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});return o.ok?(e.debugMode&&console.log("[DataSubmitter] Impression submitted successfully"),!0):(console.warn("[DataSubmitter] Impression failed with status:",o.status),!1)}catch(i){return e.log(i,"DataSubmitter.submitImpression"),!1}}}class a{constructor(e){this.onNavigate=e,this.currentUrl=window.location.href,this.listeners=[],this.pollingInterval=null,this.isActive=!1}start(n=2e3){this.isActive?e.debugMode&&console.warn("[NavigationMonitor] Already started"):(this.isActive=!0,this._listenToNativeEvents(),this._startPolling(n),e.debugMode&&console.log("[NavigationMonitor] Started",{pollingInterval:n}))}stop(){this.isActive&&(this.listeners.forEach(([e,n,t,s])=>{e.removeEventListener(n,t,s)}),this.listeners=[],this.pollingInterval&&(clearInterval(this.pollingInterval),this.pollingInterval=null),this.isActive=!1,e.debugMode&&console.log("[NavigationMonitor] Stopped"))}_listenToNativeEvents(){const e=()=>this._checkUrlChange();window.addEventListener("popstate",e),this.listeners.push([window,"popstate",e]);const n=()=>this._checkUrlChange();window.addEventListener("hashchange",n),this.listeners.push([window,"hashchange",n]);const t=e=>{const n=e.target.closest("a");n&&n.href&&"#"!==n.href&&setTimeout(()=>this._checkUrlChange(),100)};document.addEventListener("click",t,!0),this.listeners.push([document,"click",t,!0]);const s=()=>{setTimeout(()=>this._checkUrlChange(),100)};document.addEventListener("submit",s,!0),this.listeners.push([document,"submit",s,!0])}_startPolling(e){this.pollingInterval=setInterval(()=>{this._checkUrlChange()},e)}_checkUrlChange(){const n=window.location.href;n!==this.currentUrl&&(e.debugMode&&console.log("[NavigationMonitor] URL changed:",{from:this.currentUrl,to:n}),this.currentUrl=n,e.wrap(()=>{this.onNavigate(n)},"NavigationMonitor.onNavigate")())}checkNow(){this._checkUrlChange()}}class o{static validate(n,t){try{const{type:e,responseConfig:s={},validation:i={}}=t,a=[];if(!i||0===Object.keys(i).length)return{valid:!0,errors:[]};switch(e){case"textarea":this._validateTextarea(n,i,a);break;case"select":case"dropdown":this._validateSelect(n,i,a);break;case"rating":case"nps":case"scale":this._validateNumeric(n,i,a);break;case"boolean":this._validateBoolean(n,i,a);break;default:this._validateGeneric(n,i,a)}if(i.custom&&"function"==typeof i.custom){const e=i.custom(n);!0!==e&&"string"==typeof e&&a.push(e)}return{valid:0===a.length,errors:a}}catch(s){return e.log(s,"ValidationManager.validate"),{valid:!0,errors:[]}}}static _validateTextarea(e,n,t){if(null==e||""===e)return void(!1!==n.required&&t.push(n.requiredMessage||"Ce champ est requis"));const s=String(e);if(void 0!==n.minLength&&s.length<n.minLength&&t.push(n.minLengthMessage||`La réponse doit contenir au moins ${n.minLength} caractères`),void 0!==n.maxLength&&s.length>n.maxLength&&t.push(n.maxLengthMessage||`La réponse ne doit pas dépasser ${n.maxLength} caractères`),n.pattern){new RegExp(n.pattern).test(s)||t.push(n.patternMessage||"Le format de la réponse est incorrect")}if(n.forbiddenWords&&Array.isArray(n.forbiddenWords)){const e=s.toLowerCase(),i=n.forbiddenWords.filter(n=>e.includes(n.toLowerCase()));i.length>0&&t.push(n.forbiddenWordsMessage||`Votre réponse contient des mots non autorisés : ${i.join(", ")}`)}}static _validateSelect(e,n,t){null!=e&&""!==e?n.forbiddenValues&&Array.isArray(n.forbiddenValues)&&n.forbiddenValues.includes(e)&&t.push(n.forbiddenValuesMessage||"Cette option n'est pas autorisée"):!1!==n.required&&t.push(n.requiredMessage||"Veuillez sélectionner une option")}static _validateNumeric(e,n,t){if(null==e)return void(!1!==n.required&&t.push(n.requiredMessage||"Veuillez sélectionner une valeur"));const s=Number(e);void 0!==n.min&&s<n.min&&t.push(n.minMessage||`La valeur minimale est ${n.min}`),void 0!==n.max&&s>n.max&&t.push(n.maxMessage||`La valeur maximale est ${n.max}`),n.forbiddenValues&&Array.isArray(n.forbiddenValues)&&n.forbiddenValues.includes(s)&&t.push(n.forbiddenValuesMessage||"Cette valeur n'est pas autorisée")}static _validateBoolean(e,n,t){null!=e?(n.mustBeTrue&&!0!==e&&t.push(n.mustBeTrueMessage||"Vous devez accepter pour continuer"),n.mustBeFalse&&!1!==e&&t.push(n.mustBeFalseMessage||"Vous devez refuser pour continuer")):!1!==n.required&&t.push(n.requiredMessage||"Veuillez faire un choix")}static _validateGeneric(e,n,t){null!=e&&""!==e||!1!==n.required&&t.push(n.requiredMessage||"Ce champ est requis")}static validateLive(n,t){try{const{type:e,validation:s={}}=t,i=[];if(null==n||""===n)return{valid:!0,errors:[]};if("textarea"===e){const e=String(n);if(void 0!==s.maxLength&&e.length>s.maxLength&&i.push(s.maxLengthMessage||`La réponse ne doit pas dépasser ${s.maxLength} caractères`),s.pattern){new RegExp(s.pattern).test(e)||i.push(s.patternMessage||"Le format de la réponse est incorrect")}if(s.forbiddenWords&&Array.isArray(s.forbiddenWords)){const n=e.toLowerCase(),t=s.forbiddenWords.filter(e=>n.includes(e.toLowerCase()));t.length>0&&i.push(s.forbiddenWordsMessage||`Mots non autorisés : ${t.join(", ")}`)}}return{valid:0===i.length,errors:i}}catch(s){return e.log(s,"ValidationManager.validateLive"),{valid:!0,errors:[]}}}}class r{constructor(e,n,t="bottom-right"){this.shadowHost=null,this.shadowRoot=null,this.isVisible=!1,this.currentQuestion=null,this.position=t,this.onSubmit=e,this.onDismiss=n}createShadowContainer(){if(!this.shadowHost)try{const n=document.getElementById("pulser-sdk-host");n&&(n.parentNode.removeChild(n),e.debugMode&&console.log("[UIRenderer] Removed existing pulser-sdk-host from DOM (ensuring singleton)")),this.shadowHost=document.createElement("div"),this.shadowHost.id="pulser-sdk-host",this.shadowHost.setAttribute("data-pulser-sdk","true"),this.shadowRoot=this.shadowHost.attachShadow({mode:"closed"});const t=document.createElement("style");t.textContent=this._getStyles(),this.shadowRoot.appendChild(t);const s=document.createElement("div");s.id="feedback-container",s.className="feedback-hidden",this.shadowRoot.appendChild(s),document.body.appendChild(this.shadowHost),e.debugMode&&console.log("[UIRenderer] Shadow DOM created")}catch(n){e.log(n,"UIRenderer.createShadowContainer")}}renderQuestion(n,t=null){this.shadowRoot||this.createShadowContainer();try{this.currentQuestion=n,this.currentCampaign=t;const s=this.shadowRoot.getElementById("feedback-container");if(!s)return;s.innerHTML=this._generateQuestionHTML(n),this._attachEventListeners(),e.debugMode&&console.log("[UIRenderer] Question rendered:",n.id)}catch(s){e.log(s,"UIRenderer.renderQuestion")}}renderConsent(n,t){this.shadowRoot||this.createShadowContainer();try{const s=this.shadowRoot.getElementById("feedback-container");if(!s)return;s.innerHTML=this._generateConsentHTML(n),this._attachConsentEventListeners(t),e.debugMode&&console.log("[UIRenderer] Consent screen rendered")}catch(s){e.log(s,"UIRenderer.renderConsent")}}show(){if(this.shadowRoot)try{const n=this.shadowRoot.getElementById("feedback-container");n&&(n.classList.remove("feedback-hidden"),n.classList.add("feedback-visible"),this.isVisible=!0,e.debugMode&&console.log("[UIRenderer] Widget shown"))}catch(n){e.log(n,"UIRenderer.show")}}hide(){if(this.shadowRoot)try{const n=this.shadowRoot.getElementById("feedback-container");n&&(n.classList.remove("feedback-visible"),n.classList.add("feedback-hidden"),this.isVisible=!1,e.debugMode&&console.log("[UIRenderer] Widget hidden"))}catch(n){e.log(n,"UIRenderer.hide")}}destroy(){this.shadowHost&&this.shadowHost.parentNode&&(this.shadowHost.parentNode.removeChild(this.shadowHost),this.shadowHost=null,this.shadowRoot=null,this.isVisible=!1,e.debugMode&&console.log("[UIRenderer] Widget destroyed"))}_generateQuestionHTML(e){const n=this._shouldAutoSubmit(e);return`\n      <div class="feedback-widget">\n        <div class="feedback-header">\n          <h3 class="feedback-title">${this._escapeHtml(e.title)}</h3>\n          <button type="button" id="feedback-close" class="feedback-close" aria-label="Fermer">\n            <svg width="16" height="16" viewBox="0 0 16 16" fill="none">\n              <path d="M12 4L4 12M4 4L12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>\n            </svg>\n          </button>\n        </div>\n        \n        ${e.assistiveText?`\n          <p class="feedback-assistive">${this._escapeHtml(e.assistiveText)}</p>\n        `:""}\n        \n        <form id="feedback-form" class="feedback-form">\n          ${this._generateInputField(e)}\n          ${n?"":'<button type="submit" class="feedback-submit">Envoyer</button>'}\n        </form>\n      </div>\n    `}_generateInputField(e){const{type:n,responseConfig:t={}}=e;switch(n){case"textarea":default:return this._renderTextarea(t);case"rating":return this._renderRating(t);case"boolean":return this._renderBoolean(t);case"nps":return this._renderNPS(t);case"scale":return this._renderScale(t);case"select":case"dropdown":return this._renderSelect(t)}}_renderTextarea(e){const n=e.maxChars||500,t=e.placeholder||"Votre réponse...";return`\n      <textarea \n        name="answer" \n        class="feedback-textarea" \n        maxlength="${n}"\n        placeholder="${this._escapeHtml(t)}"\n        required\n      ></textarea>\n      <div class="feedback-char-count">\n        <span class="char-current">0</span> / ${n}\n      </div>\n    `}_renderRating(e){const n=e.max||5,t=e.labels||{};let s='<div class="feedback-rating">';for(let i=1;i<=n;i++)s+=`\n        <label class="feedback-rating-item">\n          <input type="radio" name="rating" value="${i}" required>\n          <span class="feedback-star">★</span>\n          ${t[i]?`<span class="feedback-rating-label">${this._escapeHtml(t[i])}</span>`:""}\n        </label>\n      `;return s+="</div>",s}_renderBoolean(e){const n=e.yesLabel||"Oui",t=e.noLabel||"Non";return`\n      <div class="feedback-boolean">\n        <label class="feedback-boolean-item">\n          <input type="radio" name="boolean" value="true" required>\n          <span class="feedback-boolean-label">${this._escapeHtml(n)}</span>\n        </label>\n        <label class="feedback-boolean-item">\n          <input type="radio" name="boolean" value="false" required>\n          <span class="feedback-boolean-label">${this._escapeHtml(t)}</span>\n        </label>\n      </div>\n    `}_renderNPS(e){const n=e.minLabel||"Pas du tout probable",t=e.maxLabel||"Très probable";let s='<div class="feedback-nps">';s+=`<div class="feedback-nps-labels">\n      <span>${this._escapeHtml(n)}</span>\n      <span>${this._escapeHtml(t)}</span>\n    </div>`,s+='<div class="feedback-nps-scale">';for(let i=0;i<=10;i++)s+=`\n        <label class="feedback-nps-item">\n          <input type="radio" name="nps" value="${i}" required>\n          <span class="feedback-nps-number">${i}</span>\n        </label>\n      `;return s+="</div></div>",s}_renderScale(e){const n=e.min||1,t=e.max||10;let s='<div class="feedback-scale">';for(let i=n;i<=t;i++)s+=`\n        <label class="feedback-scale-item">\n          <input type="radio" name="scale" value="${i}" required>\n          <span class="feedback-scale-number">${i}</span>\n        </label>\n      `;return s+="</div>",s}_renderSelect(e){const n=e.options||[],t=e.placeholder||"Sélectionnez une option...",s=e.allowCustom||!1;let i='<div class="feedback-select-wrapper">';return i+=`\n      <select name="select" class="feedback-select" required>\n        <option value="" disabled selected>${this._escapeHtml(t)}</option>\n    `,n.forEach(e=>{const n="string"==typeof e?e:e.value,t="string"==typeof e?e:e.label||e.value;i+=`<option value="${this._escapeHtml(n)}">${this._escapeHtml(t)}</option>`}),s&&(i+='<option value="__custom__">Autre...</option>'),i+="</select>",s&&(i+='\n        <input \n          type="text" \n          name="customAnswer" \n          class="feedback-custom-input feedback-custom-hidden" \n          placeholder="Votre réponse..."\n          maxlength="200"\n        />\n      '),i+="</div>",i}_attachEventListeners(){const n=this.shadowRoot.getElementById("feedback-form"),t=this.shadowRoot.getElementById("feedback-close");n&&n.addEventListener("submit",e=>{e.preventDefault(),this._submitAnswer()}),t&&t.addEventListener("click",()=>{e.wrap(()=>{this.onDismiss(this.currentQuestion.id)},"UIRenderer.onDismiss")(),this.hide()});const s=this.shadowRoot.querySelector("textarea");if(s){const e=this.shadowRoot.querySelector(".char-current");s.addEventListener("input",()=>{if(e&&(e.textContent=s.value.length),this.currentQuestion.validation){const e=s.value.trim(),n=o.validateLive(e,this.currentQuestion);n.valid?this._clearValidationErrors():this._showValidationErrors(n.errors)}})}const i=this.shadowRoot.querySelector('select[name="select"]'),a=this.shadowRoot.querySelector('input[name="customAnswer"]');i&&a&&i.addEventListener("change",()=>{"__custom__"===i.value?(a.classList.remove("feedback-custom-hidden"),a.required=!0,a.focus()):(a.classList.add("feedback-custom-hidden"),a.required=!1,a.value="")}),this._shouldAutoSubmit(this.currentQuestion)&&this._attachAutoSubmitListeners(),this._attachRatingHoverEffect()}_attachRatingHoverEffect(){const e=this.shadowRoot.querySelectorAll(".feedback-rating-item input"),n=this.shadowRoot.querySelectorAll(".feedback-star");e.forEach((e,t)=>{e.addEventListener("mouseenter",()=>{n.forEach((e,n)=>{n<=t?e.classList.add("hovered"):e.classList.remove("hovered")})}),e.addEventListener("change",()=>{n.forEach((e,n)=>{n<=t?e.classList.add("selected"):e.classList.remove("selected")})})});const t=this.shadowRoot.querySelector(".feedback-rating");t&&t.addEventListener("mouseleave",()=>{n.forEach(e=>e.classList.remove("hovered"))})}_extractAnswer(){switch(this.currentQuestion.type){case"textarea":const e=this.shadowRoot.querySelector("textarea");return e?e.value.trim():null;case"rating":const n=this.shadowRoot.querySelector('input[name="rating"]:checked');return n?parseInt(n.value,10):null;case"boolean":const t=this.shadowRoot.querySelector('input[name="boolean"]:checked');return t?"true"===t.value:null;case"nps":const s=this.shadowRoot.querySelector('input[name="nps"]:checked');return s?parseInt(s.value,10):null;case"scale":const i=this.shadowRoot.querySelector('input[name="scale"]:checked');return i?parseInt(i.value,10):null;case"select":case"dropdown":const a=this.shadowRoot.querySelector('select[name="select"]');if(!a)return null;if("__custom__"===a.value){const e=this.shadowRoot.querySelector('input[name="customAnswer"]');return e?e.value.trim():null}return a.value||null;default:return null}}_shouldAutoSubmit(e){const{type:n,responseConfig:t={}}=e;return!0!==t.requireSubmitButton&&["nps","rating","boolean","scale"].includes(n)}_attachAutoSubmitListeners(){this.shadowRoot.querySelectorAll('input[type="radio"]').forEach(e=>{e.addEventListener("change",()=>{setTimeout(()=>{this._submitAnswer()},300)})}),e.debugMode&&console.log("[UIRenderer] Auto-submit listeners attached")}_submitAnswer(){const n=this._extractAnswer();if(null!==n){const t=o.validate(n,this.currentQuestion);if(!t.valid)return this._showValidationErrors(t.errors),void(e.debugMode&&console.warn("[UIRenderer] Validation failed:",t.errors));this._clearValidationErrors(),e.wrap(()=>{this.onSubmit(this.currentQuestion.id,n)},"UIRenderer.onSubmit")(),this._showThankYouMessage()}}_showThankYouMessage(){const n=this.currentQuestion.thankYouMessage||this.currentCampaign?.thankYouMessage;if(!n||!n.enabled)return void this.hide();let t=n.text||"Merci pour votre réponse !";const s=Array.isArray(t);if(s)if(0===t.length)t="Merci pour votre réponse !";else{const s=Math.floor(Math.random()*t.length);t=t[s],e.debugMode&&console.log("[UIRenderer] Random message selected from array:",{index:s,totalMessages:n.text.length,selectedMessage:t})}const i=t,a=n.duration||2e3,o=this.shadowRoot.querySelector(".feedback-widget");o&&(o.innerHTML=`\n        <div class="feedback-thankyou">\n          <div class="feedback-thankyou-icon">\n            <svg width="48" height="48" viewBox="0 0 48 48" fill="none">\n              <circle cx="24" cy="24" r="20" fill="#10b981" opacity="0.1"/>\n              <path d="M14 24l8 8 16-16" stroke="#10b981" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>\n            </svg>\n          </div>\n          <p class="feedback-thankyou-message">${this._escapeHtml(i)}</p>\n        </div>\n      `),setTimeout(()=>{this.hide()},a),e.debugMode&&console.log("[UIRenderer] Thank you message displayed:",{message:i,duration:a,wasArray:s})}_showValidationErrors(n){if(!n||0===n.length)return;this._clearValidationErrors();const t=this.shadowRoot.getElementById("feedback-form");if(!t)return;const s=document.createElement("div");s.className="feedback-validation-errors",s.innerHTML=n.map(e=>`\n      <div class="feedback-validation-error">\n        <svg width="16" height="16" viewBox="0 0 16 16" fill="none">\n          <circle cx="8" cy="8" r="7" stroke="#ef4444" stroke-width="1.5"/>\n          <path d="M8 4v5M8 11h.01" stroke="#ef4444" stroke-width="1.5" stroke-linecap="round"/>\n        </svg>\n        <span>${this._escapeHtml(e)}</span>\n      </div>\n    `).join(""),t.insertBefore(s,t.firstChild),e.debugMode&&console.log("[UIRenderer] Validation errors displayed:",n)}_clearValidationErrors(){const e=this.shadowRoot.querySelector(".feedback-validation-errors");e&&e.remove()}_generateConsentHTML(e){return`\n      <div class="feedback-widget feedback-consent-widget">\n        <div class="feedback-header">\n          <h3 class="feedback-title">${this._escapeHtml(e.title)}</h3>\n          <button type="button" id="feedback-close" class="feedback-close" aria-label="Fermer">\n            <svg width="16" height="16" viewBox="0 0 16 16" fill="none">\n              <path d="M12 4L4 12M4 4L12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>\n            </svg>\n          </button>\n        </div>\n        \n        <div class="feedback-consent-content">\n          <p class="feedback-consent-description">${this._escapeHtml(e.description)}</p>\n          \n          ${e.learnMoreUrl?`\n            <a href="${this._escapeHtml(e.learnMoreUrl)}" \n               target="_blank" \n               rel="noopener noreferrer" \n               class="feedback-consent-learn-more">\n              ${this._escapeHtml(e.learnMoreText)}\n              <svg width="12" height="12" viewBox="0 0 12 12" fill="none">\n                <path d="M3 9L9 3M9 3H4M9 3v5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>\n              </svg>\n            </a>\n          `:""}\n          \n          <div class="feedback-consent-data-info">\n            <div class="feedback-consent-data-icon">\n              <svg width="20" height="20" viewBox="0 0 20 20" fill="none">\n                <circle cx="10" cy="10" r="8" stroke="#6b7280" stroke-width="1.5"/>\n                <path d="M10 7v5M10 13h.01" stroke="#6b7280" stroke-width="1.5" stroke-linecap="round"/>\n              </svg>\n            </div>\n            <p class="feedback-consent-data-text">${this._escapeHtml(e.dataCollectionInfo)}</p>\n          </div>\n          \n          ${e.privacyPolicyUrl?`\n            <a href="${this._escapeHtml(e.privacyPolicyUrl)}" \n               target="_blank" \n               rel="noopener noreferrer" \n               class="feedback-consent-privacy-link">\n              Politique de confidentialité\n            </a>\n          `:""}\n        </div>\n        \n        <div class="feedback-consent-actions">\n          <button type="button" id="feedback-consent-accept" class="feedback-consent-button feedback-consent-accept">\n            ${this._escapeHtml(e.acceptLabel)}\n          </button>\n          <button type="button" id="feedback-consent-decline" class="feedback-consent-button feedback-consent-decline">\n            ${this._escapeHtml(e.declineLabel)}\n          </button>\n        </div>\n      </div>\n    `}_attachConsentEventListeners(n){const t=this.shadowRoot.getElementById("feedback-close");t&&t.addEventListener("click",()=>{this.hide(),this.onDismiss&&this.onDismiss("consent_dismissed")});const s=this.shadowRoot.getElementById("feedback-consent-accept");s&&s.addEventListener("click",()=>{e.debugMode&&console.log("[UIRenderer] Consent accepted"),n(!0)});const i=this.shadowRoot.getElementById("feedback-consent-decline");i&&i.addEventListener("click",()=>{e.debugMode&&console.log("[UIRenderer] Consent declined"),n(!1)})}_escapeHtml(e){const n=document.createElement("div");return n.textContent=e,n.innerHTML}_getPositionConfig(){const e="20px",n={"bottom-right":{css:`bottom: ${e}; right: ${e};`,hidden:"translateY(20px) scale(0.95)",visible:"translateY(0) scale(1)"},"bottom-left":{css:`bottom: ${e}; left: ${e};`,hidden:"translateY(20px) scale(0.95)",visible:"translateY(0) scale(1)"},"top-right":{css:`top: ${e}; right: ${e};`,hidden:"translateY(-20px) scale(0.95)",visible:"translateY(0) scale(1)"},"top-left":{css:`top: ${e}; left: ${e};`,hidden:"translateY(-20px) scale(0.95)",visible:"translateY(0) scale(1)"},"top-center":{css:`top: ${e}; left: 50%;`,hidden:"translate(-50%, -20px) scale(0.95)",visible:"translate(-50%, 0) scale(1)"},"bottom-center":{css:`bottom: ${e}; left: 50%;`,hidden:"translate(-50%, 20px) scale(0.95)",visible:"translate(-50%, 0) scale(1)"},"middle-right":{css:`top: 50%; right: ${e};`,hidden:"translate(20px, -50%) scale(0.95)",visible:"translate(0, -50%) scale(1)"},"middle-left":{css:`top: 50%; left: ${e};`,hidden:"translate(-20px, -50%) scale(0.95)",visible:"translate(0, -50%) scale(1)"},center:{css:"top: 50%; left: 50%;",hidden:"translate(-50%, -50%) scale(0.95)",visible:"translate(-50%, -50%) scale(1)"}};return n[this.position||"bottom-right"]||n["bottom-right"]}_getStyles(){const e=this._getPositionConfig();return`\n      /* Reset */\n      * {\n        box-sizing: border-box;\n        margin: 0;\n        padding: 0;\n      }\n\n      /* Container */\n      #feedback-container {\n        position: fixed;\n        ${e.css}\n        z-index: 999999;\n        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;\n        transition: opacity 0.3s ease, transform 0.3s ease;\n        width: auto;\n        max-width: 100vw;\n      }\n\n      #feedback-container.feedback-hidden {\n        opacity: 0;\n        transform: ${e.hidden};\n        pointer-events: none;\n      }\n\n      #feedback-container.feedback-visible {\n        opacity: 1;\n        transform: ${e.visible};\n      }\n\n      /* Widget Principal */\n      .feedback-widget {\n        background: white;\n        border-radius: 12px;\n        box-shadow: 0 4px 24px rgba(0, 0, 0, 0.15);\n        padding: 20px;\n        width: 380px;\n        max-width: 380px;\n        min-width: 280px;\n      }\n\n      /* MOBILE RESPONSIVE - Force fullwidth en bas sur mobile */\n      @media (max-width: 768px) {\n        #feedback-container {\n          position: fixed !important;\n          bottom: 0 !important;\n          left: 0 !important;\n          right: 0 !important;\n          top: auto !important;\n          transform: none !important;\n          padding: 0 12px 12px 12px;\n        }\n\n        #feedback-container.feedback-hidden {\n          transform: translateY(100%) !important;\n          opacity: 0;\n        }\n\n        #feedback-container.feedback-visible {\n          transform: translateY(0) !important;\n          opacity: 1;\n        }\n\n        .feedback-widget {\n          width: 100%;\n          max-width: 100%;\n          min-width: 100%;\n          border-bottom-left-radius: 0;\n          border-bottom-right-radius: 0;\n          box-shadow: 0 -4px 24px rgba(0, 0, 0, 0.15);\n        }\n      }\n\n      /* TABLET - Réduction progressive */\n      @media (max-width: 1024px) and (min-width: 769px) {\n        .feedback-widget {\n          width: 340px;\n          max-width: 340px;\n        }\n      }\n\n      /* DESKTOP - Assurer que le container sur les positions centrées prend la bonne largeur */\n      @media (min-width: 769px) {\n        #feedback-container {\n          width: max-content;\n        }\n      }\n\n      /* Header */\n      .feedback-header {\n        display: flex;\n        justify-content: space-between;\n        align-items: flex-start;\n        margin-bottom: 12px;\n      }\n\n      .feedback-title {\n        font-size: 16px;\n        font-weight: 600;\n        color: #1a1a1a;\n        line-height: 1.4;\n        margin: 0;\n        padding-right: 8px;\n      }\n\n      .feedback-close {\n        background: none;\n        border: none;\n        cursor: pointer;\n        padding: 4px;\n        color: #666;\n        transition: color 0.2s;\n        flex-shrink: 0;\n      }\n\n      .feedback-close:hover {\n        color: #000;\n      }\n\n      .feedback-assistive {\n        font-size: 14px;\n        color: #666;\n        margin-bottom: 16px;\n        line-height: 1.5;\n      }\n\n      /* Form */\n      .feedback-form {\n        display: flex;\n        flex-direction: column;\n        gap: 16px;\n      }\n\n      /* Textarea */\n      .feedback-textarea {\n        width: 100%;\n        min-height: 80px;\n        padding: 12px;\n        border: 1px solid #ddd;\n        border-radius: 8px;\n        font-family: inherit;\n        font-size: 14px;\n        resize: vertical;\n        transition: border-color 0.2s;\n      }\n\n      .feedback-textarea:focus {\n        outline: none;\n        border-color: #0066ff;\n      }\n\n      .feedback-char-count {\n        font-size: 12px;\n        color: #999;\n        text-align: right;\n      }\n\n      /* Rating (Étoiles) */\n      .feedback-rating {\n        display: flex;\n        gap: 8px;\n        justify-content: center;\n      }\n\n      .feedback-rating-item {\n        cursor: pointer;\n        display: flex;\n        flex-direction: column;\n        align-items: center;\n        gap: 4px;\n      }\n\n      .feedback-rating-item input {\n        position: absolute;\n        opacity: 0;\n      }\n\n      .feedback-star {\n        font-size: 32px;\n        color: #ddd;\n        transition: color 0.2s;\n      }\n\n      .feedback-star.hovered,\n      .feedback-star.selected {\n        color: #ffc107;\n      }\n\n      .feedback-rating-label {\n        font-size: 11px;\n        color: #666;\n      }\n\n      /* Boolean */\n      .feedback-boolean {\n        display: flex;\n        gap: 12px;\n      }\n\n      .feedback-boolean-item {\n        flex: 1;\n        cursor: pointer;\n      }\n\n      .feedback-boolean-item input {\n        position: absolute;\n        opacity: 0;\n      }\n\n      .feedback-boolean-label {\n        display: block;\n        padding: 12px;\n        border: 2px solid #ddd;\n        border-radius: 8px;\n        text-align: center;\n        font-size: 14px;\n        font-weight: 500;\n        transition: all 0.2s;\n      }\n\n      .feedback-boolean-item input:checked + .feedback-boolean-label {\n        border-color: #0066ff;\n        background: #f0f7ff;\n        color: #0066ff;\n      }\n\n      /* NPS */\n      .feedback-nps {\n        display: flex;\n        flex-direction: column;\n        gap: 8px;\n      }\n\n      .feedback-nps-labels {\n        display: flex;\n        justify-content: space-between;\n        font-size: 11px;\n        color: #666;\n      }\n\n      .feedback-nps-scale {\n        display: flex;\n        gap: 4px;\n        justify-content: space-between;\n      }\n\n      .feedback-nps-item {\n        flex: 1;\n        cursor: pointer;\n      }\n\n      .feedback-nps-item input {\n        position: absolute;\n        opacity: 0;\n      }\n\n      .feedback-nps-number {\n        display: block;\n        padding: 8px 4px;\n        border: 1px solid #ddd;\n        border-radius: 6px;\n        text-align: center;\n        font-size: 13px;\n        font-weight: 500;\n        transition: all 0.2s;\n      }\n\n      .feedback-nps-item input:checked + .feedback-nps-number {\n        border-color: #0066ff;\n        background: #0066ff;\n        color: white;\n      }\n\n      /* Scale */\n      .feedback-scale {\n        display: flex;\n        gap: 6px;\n        flex-wrap: wrap;\n        justify-content: center;\n      }\n\n      .feedback-scale-item {\n        cursor: pointer;\n      }\n\n      .feedback-scale-item input {\n        position: absolute;\n        opacity: 0;\n      }\n\n      .feedback-scale-number {\n        display: block;\n        width: 40px;\n        height: 40px;\n        line-height: 40px;\n        border: 1px solid #ddd;\n        border-radius: 6px;\n        text-align: center;\n        font-size: 14px;\n        font-weight: 500;\n        transition: all 0.2s;\n      }\n\n      .feedback-scale-item input:checked + .feedback-scale-number {\n        border-color: #0066ff;\n        background: #0066ff;\n        color: white;\n      }\n\n      /* Select / Dropdown */\n      .feedback-select-wrapper {\n        display: flex;\n        flex-direction: column;\n        gap: 12px;\n      }\n\n      .feedback-select {\n        width: 100%;\n        padding: 10px 12px;\n        border: 2px solid #ddd;\n        border-radius: 6px;\n        font-family: inherit;\n        font-size: 15px;\n        color: #333;\n        background-color: white;\n        cursor: pointer;\n        transition: border-color 0.2s;\n      }\n\n      .feedback-select:hover {\n        border-color: #999;\n      }\n\n      .feedback-select:focus {\n        outline: 2px solid #0066ff;\n        outline-offset: 2px;\n        border-color: #0066ff;\n      }\n\n      .feedback-select:disabled {\n        background: #f5f5f5;\n        color: #999;\n        cursor: not-allowed;\n      }\n\n      .feedback-select option {\n        color: #333;\n        background-color: white;\n        padding: 8px;\n      }\n\n      .feedback-custom-input {\n        width: 100%;\n        padding: 10px 12px;\n        border: 2px solid #ddd;\n        border-radius: 6px;\n        font-family: inherit;\n        font-size: 15px;\n        color: #333;\n        background-color: white;\n        transition: border-color 0.2s, opacity 0.2s, max-height 0.3s;\n      }\n\n      .feedback-custom-input:hover {\n        border-color: #999;\n      }\n\n      .feedback-custom-input:focus {\n        outline: 2px solid #0066ff;\n        outline-offset: 2px;\n        border-color: #0066ff;\n      }\n\n      .feedback-custom-hidden {\n        display: none;\n      }\n\n      /* Consent Screen */\n      .feedback-consent-widget {\n        max-width: 450px;\n      }\n\n      .feedback-consent-content {\n        padding: 0 24px 20px 24px;\n        display: flex;\n        flex-direction: column;\n        gap: 16px;\n      }\n\n      .feedback-consent-description {\n        font-size: 15px;\n        line-height: 1.6;\n        color: #374151;\n        margin: 0;\n      }\n\n      .feedback-consent-learn-more {\n        display: inline-flex;\n        align-items: center;\n        gap: 4px;\n        color: #0066ff;\n        text-decoration: none;\n        font-size: 14px;\n        font-weight: 500;\n        transition: color 0.2s;\n      }\n\n      .feedback-consent-learn-more:hover {\n        color: #0052cc;\n        text-decoration: underline;\n      }\n\n      .feedback-consent-data-info {\n        display: flex;\n        gap: 12px;\n        padding: 14px;\n        background: #f9fafb;\n        border: 1px solid #e5e7eb;\n        border-radius: 8px;\n      }\n\n      .feedback-consent-data-icon {\n        flex-shrink: 0;\n      }\n\n      .feedback-consent-data-text {\n        font-size: 13px;\n        line-height: 1.5;\n        color: #6b7280;\n        margin: 0;\n      }\n\n      .feedback-consent-privacy-link {\n        display: inline-block;\n        color: #6b7280;\n        text-decoration: underline;\n        font-size: 13px;\n        transition: color 0.2s;\n      }\n\n      .feedback-consent-privacy-link:hover {\n        color: #374151;\n      }\n\n      .feedback-consent-actions {\n        display: flex;\n        flex-direction: column;\n        gap: 10px;\n        padding: 0 24px 24px 24px;\n      }\n\n      .feedback-consent-button {\n        width: 100%;\n        padding: 12px 24px;\n        border: none;\n        border-radius: 8px;\n        font-size: 14px;\n        font-weight: 600;\n        cursor: pointer;\n        transition: all 0.2s;\n      }\n\n      .feedback-consent-accept {\n        background: #0066ff;\n        color: white;\n      }\n\n      .feedback-consent-accept:hover {\n        background: #0052cc;\n      }\n\n      .feedback-consent-decline {\n        background: #f3f4f6;\n        color: #6b7280;\n      }\n\n      .feedback-consent-decline:hover {\n        background: #e5e7eb;\n        color: #374151;\n      }\n\n      .feedback-consent-button:active {\n        transform: scale(0.98);\n      }\n\n      /* Validation Errors */\n      .feedback-validation-errors {\n        display: flex;\n        flex-direction: column;\n        gap: 8px;\n        margin-bottom: 12px;\n      }\n\n      .feedback-validation-error {\n        display: flex;\n        align-items: flex-start;\n        gap: 8px;\n        padding: 10px 12px;\n        background: #fef2f2;\n        border: 1px solid #fecaca;\n        border-radius: 6px;\n        font-size: 13px;\n        color: #dc2626;\n        line-height: 1.4;\n      }\n\n      .feedback-validation-error svg {\n        flex-shrink: 0;\n        margin-top: 1px;\n      }\n\n      .feedback-validation-error span {\n        flex: 1;\n      }\n\n      /* Submit Button */\n      .feedback-submit {\n        background: #0066ff;\n        color: white;\n        border: none;\n        padding: 12px;\n        border-radius: 8px;\n        font-size: 14px;\n        font-weight: 600;\n        cursor: pointer;\n        transition: background 0.2s;\n      }\n\n      .feedback-submit:hover {\n        background: #0052cc;\n      }\n\n      .feedback-submit:active {\n        transform: scale(0.98);\n      }\n\n      .feedback-submit:disabled {\n        background: #ccc;\n        cursor: not-allowed;\n      }\n\n      /* Thank You Message */\n      .feedback-thankyou {\n        display: flex;\n        flex-direction: column;\n        align-items: center;\n        justify-content: center;\n        text-align: center;\n        padding: 32px 24px;\n        min-height: 200px;\n      }\n\n      .feedback-thankyou-icon {\n        margin-bottom: 16px;\n        animation: thankYouScale 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);\n      }\n\n      @keyframes thankYouScale {\n        0% {\n          transform: scale(0);\n          opacity: 0;\n        }\n        100% {\n          transform: scale(1);\n          opacity: 1;\n        }\n      }\n\n      .feedback-thankyou-message {\n        font-size: 16px;\n        font-weight: 500;\n        color: #333;\n        margin: 0;\n        line-height: 1.5;\n        animation: thankYouFadeIn 0.4s ease-out 0.2s both;\n      }\n\n      @keyframes thankYouFadeIn {\n        0% {\n          opacity: 0;\n          transform: translateY(10px);\n        }\n        100% {\n          opacity: 1;\n          transform: translateY(0);\n        }\n      }\n\n      /* Container Queries - Responsive - Pour desktop uniquement */\n      @media (min-width: 769px) {\n        @container feedback (max-width: 320px) {\n          .feedback-widget {\n            padding: 16px;\n            max-width: 100%;\n          }\n\n          .feedback-title {\n            font-size: 14px;\n          }\n\n          .feedback-star {\n            font-size: 24px;\n          }\n\n          .feedback-nps-scale {\n            gap: 2px;\n          }\n\n          .feedback-nps-number {\n            font-size: 11px;\n            padding: 6px 2px;\n          }\n        }\n\n        @container feedback (min-width: 400px) {\n          .feedback-widget {\n            padding: 24px;\n          }\n\n          .feedback-title {\n            font-size: 18px;\n          }\n        }\n      }\n\n      /* Mobile optimizations - Petits ajustements */\n      @media (max-width: 768px) {\n        .feedback-star {\n          font-size: 28px;\n        }\n\n        .feedback-rating {\n          gap: 6px;\n        }\n\n        .feedback-nps-scale {\n          gap: 3px;\n        }\n\n        .feedback-nps-number {\n          font-size: 12px;\n          padding: 6px 2px;\n        }\n\n        .feedback-nps-labels {\n          font-size: 10px;\n        }\n      }\n    `}}class l{constructor(e){this.storageManager=e,this.config=null}setConfig(n){this.config={enabled:!1!==n?.enabled,title:n?.title||"Votre avis nous intéresse",description:n?.description||"Nous aimerions recueillir vos retours pour améliorer votre expérience.",learnMoreText:n?.learnMoreText||"En savoir plus",learnMoreUrl:n?.learnMoreUrl||null,dataCollectionInfo:n?.dataCollectionInfo||"Nous collectons vos réponses de manière anonyme pour améliorer nos services. Vos données ne seront jamais partagées avec des tiers.",acceptLabel:n?.acceptLabel||"Oui, j'accepte",declineLabel:n?.declineLabel||"Non merci",privacyPolicyUrl:n?.privacyPolicyUrl||null},e.debugMode&&console.log("[ConsentManager] Configuration mise à jour:",this.config)}isConsentRequired(){try{if(!this.config||!this.config.enabled)return!1;return null===this.storageManager.getConsent()}catch(n){return e.log(n,"ConsentManager.isConsentRequired"),!1}}hasConsent(){try{if(!this.config||!this.config.enabled)return!0;return!0===this.storageManager.getConsent()}catch(n){return e.log(n,"ConsentManager.hasConsent"),!1}}saveConsent(n){try{this.storageManager.setConsent(n),e.debugMode&&console.log("[ConsentManager] Consentement "+(n?"accepté":"refusé")),n||(this.storageManager.clearAllResponses(),this.storageManager.clearAllImpressions(),e.debugMode&&console.log("[ConsentManager] Données utilisateur effacées (refus de consentement)"))}catch(t){e.log(t,"ConsentManager.saveConsent")}}resetConsent(){try{this.storageManager.clearConsent(),e.debugMode&&console.log("[ConsentManager] Consentement réinitialisé")}catch(n){e.log(n,"ConsentManager.resetConsent")}}getConfig(){return this.config}getStatus(){try{const e=this.storageManager.getConsent();return{enabled:this.config?.enabled||!1,required:this.isConsentRequired(),hasConsent:this.hasConsent(),status:e}}catch(n){return e.log(n,"ConsentManager.getStatus"),{enabled:!1,required:!1,hasConsent:!0,status:null}}}}class c{static instance=null;constructor(){if(c.instance)return e.debugMode&&console.warn("[PulserSDK] Instance already exists, returning existing instance"),c.instance;this.domain=null,this.language="en",this.specificId=null,this.debugMode=!1,this.position="bottom-right",this.storageManager=null,this.configManager=null,this.decisionEngine=null,this.dataSubmitter=null,this.navigationMonitor=null,this.uiRenderer=null,this.consentManager=null,this.isInitialized=!1,this.campaigns=[],this.currentCampaign=null,this.currentQuestion=null,this.pollingInterval=2e3,this.isDisplaying=!1,this.lastTriggerTime=0,this.debounceDelay=500,c.instance=this}async init(n,t="en",s=null,i={}){this.isInitialized?console.warn("[PulserSDK] Already initialized"):(this.domain=n,this.language=t,this.specificId=s,this.debugMode=i.debug||!1,this.pollingInterval=i.pollingInterval||2e3,this.position=i.position||"bottom-right",this.debugMode&&e.enableDebug(),await e.wrap(async()=>{e.debugMode&&console.log("[PulserSDK] Initializing...",{domain:n,language:t,specificId:s,debug:this.debugMode}),this._setupModules(),await this._fetchConfiguration(),this._startMonitoring(),this.isInitialized=!0,e.debugMode&&console.log("[PulserSDK] Initialized successfully",{campaignsCount:this.campaigns.length})},"init")())}_setupModules(){this.storageManager=new n,this.configManager=new t(this.domain,this.language,this.specificId,this.storageManager),this.decisionEngine=new s(this.storageManager),this.dataSubmitter=new i(this.domain),this.uiRenderer=new r(this._handleSubmit.bind(this),this._handleDismiss.bind(this),this.position),this.navigationMonitor=new a(this._handlePageChange.bind(this)),this.consentManager=new l(this.storageManager),e.debugMode&&console.log("[PulserSDK] Modules initialized")}async _fetchConfiguration(){const n=await this.configManager.fetchConfig();this.campaigns=n.campaigns||[],n.consent?this.consentManager.setConfig(n.consent):this.consentManager.setConfig({enabled:!0}),e.debugMode&&console.log("[PulserSDK] Configuration loaded:",{campaignsCount:this.campaigns.length,campaigns:this.campaigns.map(e=>({id:e.id,name:e.name,priority:e.priority,questionsCount:e.questions?.length||0})),consentStatus:this.consentManager.getStatus()})}_startMonitoring(){this.navigationMonitor.start(this.pollingInterval),this._handlePageChange(window.location.href)}_handlePageChange(n){e.wrap(()=>{const t=Date.now();if(t-this.lastTriggerTime<this.debounceDelay)return void(e.debugMode&&console.log("[PulserSDK] Debounced: Too soon after last trigger"));if(this.isDisplaying)return void(e.debugMode&&console.log("[PulserSDK] Already displaying a question, skipping"));e.debugMode&&console.log("[PulserSDK] Page change detected:",n);const s=()=>{if(this.isDisplaying=!0,this.lastTriggerTime=t,this.consentManager.isConsentRequired()){e.debugMode&&console.log("[PulserSDK] Consent required, showing consent screen");const t=this.consentManager.getConfig();return this.uiRenderer.renderConsent(t,e=>{this.consentManager.saveConsent(e),e?this._showNextQuestion(n):(this.uiRenderer.hide(),this.isDisplaying=!1)}),void this.uiRenderer.show()}if(!this.consentManager.hasConsent())return e.debugMode&&console.log("[PulserSDK] No consent given, skipping questions"),void(this.isDisplaying=!1);this._showNextQuestion(n)};this.uiRenderer.isVisible?(e.debugMode&&console.log("[PulserSDK] Closing widget due to navigation"),this.uiRenderer.hide(),setTimeout(s,350)):s()},"handlePageChange")()}_showNextQuestion(n){const t=this.decisionEngine.findEligibleCampaign(this.campaigns,n);t?(e.debugMode&&console.log("[PulserSDK] Eligible campaign found:",{campaignId:t.campaign.id,questionId:t.question.id}),this.currentCampaign=t.campaign,this.currentQuestion=t.question,this.uiRenderer.renderQuestion(t.question,t.campaign),this.uiRenderer.show(),this.storageManager.markCampaignAsShown(t.campaign.id,t.question.id)):(e.debugMode&&console.log("[PulserSDK] No eligible campaign for this page"),this.isDisplaying=!1)}_handleSubmit(n,t){e.wrap(async()=>{this.currentCampaign?(e.debugMode&&console.log("[PulserSDK] Answer submitted:",{campaignId:this.currentCampaign.id,questionId:n,answer:t}),await this.dataSubmitter.submitAnswer(this.currentCampaign.id,n,t,this.storageManager.getAllUserData()),this.storageManager.markCampaignAsAnswered(this.currentCampaign.id,n),this.isDisplaying=!1,e.debugMode&&console.log("[PulserSDK] Answer sent successfully, display flag released")):console.warn("[PulserSDK] No current campaign")},"handleSubmit")()}_handleDismiss(n){e.wrap(async()=>{this.currentCampaign?(e.debugMode&&console.log("[PulserSDK] Question dismissed:",{campaignId:this.currentCampaign.id,questionId:n}),await this.dataSubmitter.submitImpression(this.currentCampaign.id,n,this.storageManager.getAllUserData()),this.storageManager.markCampaignAsDismissed(this.currentCampaign.id),this.isDisplaying=!1,e.debugMode&&console.log("[PulserSDK] Impression sent successfully, display flag released")):console.warn("[PulserSDK] No current campaign")},"handleDismiss")()}showCampaign(n){this.isInitialized?e.wrap(()=>{this.isDisplaying=!1;const t=this.campaigns.find(e=>e.id===n);if(t&&t.questions&&t.questions.length>0){e.debugMode&&console.log("[PulserSDK] Forcing display of campaign:",n);const s=t.questions.filter(e=>!this.storageManager.hasAnswered(t.id,e.id)),i=s.length>0?s:t.questions,a=i[Math.floor(Math.random()*i.length)];this.currentCampaign=t,this.currentQuestion=a,this.isDisplaying=!0,this.uiRenderer.renderQuestion(a,t),this.uiRenderer.show(),this.storageManager.markCampaignAsShown(t.id,a.id)}else console.warn(`[PulserSDK] Campaign not found or has no questions: ${n}`)},"showCampaign")():console.warn("[PulserSDK] Not initialized. Call init() first.")}showQuestion(n){this.isInitialized?e.wrap(()=>{this.isDisplaying=!1;for(const t of this.campaigns)if(t.questions){const s=t.questions.find(e=>e.id===n);if(s)return e.debugMode&&console.log("[PulserSDK] Forcing display of question:",{campaignId:t.id,questionId:n}),this.currentCampaign=t,this.currentQuestion=s,this.isDisplaying=!0,this.uiRenderer.renderQuestion(s,t),this.uiRenderer.show(),void this.storageManager.markCampaignAsShown(t.id,s.id)}if(e.debugMode){const e=[];this.campaigns.forEach(n=>{n.questions&&n.questions.forEach(t=>e.push({campaignId:n.id,questionId:t.id,type:t.type}))}),console.warn(`[PulserSDK] Question not found: ${n}`),console.log("[PulserSDK] Available questions:",e)}else console.warn(`[PulserSDK] Question not found: ${n}`)},"showQuestion")():console.warn("[PulserSDK] Not initialized. Call init() first.")}setUserInfo(n){this.isInitialized?e.wrap(()=>{"object"==typeof n&&null!==n?n!==window&&n!==document?(Object.entries(n).forEach(([e,n])=>{n!==window&&n!==document?this.storageManager.setUserData(e,n):console.warn(`[PulserSDK] Skipping key "${e}": cannot store window or document references`)}),e.debugMode&&console.log("[PulserSDK] User info updated:",n)):console.error("[PulserSDK] Cannot use window or document as user data"):console.warn("[PulserSDK] setUserInfo expects an object")},"setUserInfo")():console.warn("[PulserSDK] Not initialized. Call init() first.")}hide(){this.uiRenderer&&(this.uiRenderer.hide(),this.isDisplaying=!1)}show(){this.uiRenderer&&this.uiRenderer.currentQuestion&&this.uiRenderer.show()}refresh(){this.isInitialized&&this.navigationMonitor.checkNow()}updatePosition(n){this.isInitialized?e.wrap(()=>{const t=this.isDisplaying,s=this.currentQuestion,i=this.currentCampaign;this.uiRenderer&&this.uiRenderer.destroy(),this.position=n,this.uiRenderer=new r(this._handleSubmit.bind(this),this._handleDismiss.bind(this),n),t&&s&&i&&(this.currentQuestion=s,this.currentCampaign=i,this.uiRenderer.renderQuestion(s,i),this.uiRenderer.show(),this.isDisplaying=!0),e.debugMode&&console.log("[PulserSDK] Position updated to:",n)},"updatePosition")():console.warn("[PulserSDK] SDK not initialized")}destroy(){this.isInitialized&&e.wrap(()=>{this.navigationMonitor&&this.navigationMonitor.stop(),this.uiRenderer&&this.uiRenderer.destroy(),this.isInitialized=!1,this.campaigns=[],this.currentCampaign=null,this.currentQuestion=null,this.isDisplaying=!1,c.instance=null,e.debugMode&&console.log("[PulserSDK] Destroyed")},"destroy")()}clearData(){this.storageManager&&(this.storageManager.clearAll(),e.debugMode&&console.log("[PulserSDK] All data cleared"))}getConsentStatus(){return this.consentManager?this.consentManager.getStatus():{enabled:!1,required:!1,hasConsent:!0,status:null}}hasConsent(){return!this.consentManager||this.consentManager.hasConsent()}resetConsent(){this.consentManager&&e.wrap(()=>{this.consentManager.resetConsent(),e.debugMode&&console.log("[PulserSDK] Consent reset")},"resetConsent")()}setConsent(n){this.consentManager&&e.wrap(()=>{this.consentManager.saveConsent(n),e.debugMode&&console.log("[PulserSDK] Consent manually set:",n)},"setConsent")()}async reloadConfig(){if(this.isInitialized)return e.wrap(async()=>{e.debugMode&&console.log("[PulserSDK] Reloading configuration..."),this.campaigns=await this.configManager.fetchCampaigns(!0),e.debugMode&&console.log("[PulserSDK] Configuration reloaded:",{campaignsCount:this.campaigns.length,campaigns:this.campaigns.map(e=>({id:e.id,name:e.name,questionsCount:e.questions?.length||0}))})},"reloadConfig")();console.warn("[PulserSDK] Not initialized. Call init() first.")}getDebugInfo(){return{isInitialized:this.isInitialized,domain:this.domain,language:this.language,specificId:this.specificId,debugMode:this.debugMode,campaignsCount:this.campaigns.length,campaigns:this.campaigns.map(e=>({id:e.id,name:e.name,priority:e.priority,frequencyDays:e.frequencyDays,luckFactor:e.luckFactor,questionsCount:e.questions?.length||0,canShow:this.storageManager.canShowCampaign(e.id,e.frequencyDays||0)})),currentCampaign:this.currentCampaign?{id:this.currentCampaign.id,name:this.currentCampaign.name}:null,currentQuestion:this.currentQuestion?{id:this.currentQuestion.id,title:this.currentQuestion.title}:null,currentUrl:window.location.href,isWidgetVisible:this.uiRenderer?.isVisible||!1,isDisplaying:this.isDisplaying,lastTriggerTime:this.lastTriggerTime,userData:this.storageManager?.getAllUserData()||{}}}static getInstance(){return c.instance}}return function(){if("undefined"!=typeof window){const e=new c;window.PulserSDK=e,"localhost"!==window.location.hostname&&"127.0.0.1"!==window.location.hostname||(console.log("[PulserSDK] SDK loaded and ready. Usage:"),console.log('  window.PulserSDK.init("your-domain.com", "fr", null, { debug: true })'))}}(),c}();
//# sourceMappingURL=pulser-sdk.min.js.map
