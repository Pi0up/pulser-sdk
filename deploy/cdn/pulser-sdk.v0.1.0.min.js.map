{"version":3,"file":"pulser-sdk.min.js","sources":["../../src/sdk/ErrorHandler.js","../../src/sdk/StorageManager.js","../../src/sdk/ConfigManager.js","../../src/sdk/DecisionEngine.js","../../src/sdk/DataSubmitter.js","../../src/sdk/NavigationMonitor.js","../../src/sdk/ValidationManager.js","../../src/sdk/UIRenderer.js","../../src/sdk/ConsentManager.js","../../src/sdk/PulserSDK.js","../../src/sdk/index.js"],"sourcesContent":["/**\n * ErrorHandler - Gestion Fail-Safe des erreurs\n * Garantit que le SDK n'interfère jamais avec le site hôte\n */\nclass ErrorHandler {\n  static debugMode = false;\n\n  /**\n   * Enveloppe une fonction pour capturer les erreurs\n   * @param {Function} fn - Fonction à protéger\n   * @param {string} context - Contexte pour le log\n   * @returns {Function} - Fonction protégée\n   */\n  static wrap(fn, context = 'SDK') {\n    return async (...args) => {\n      try {\n        return await fn(...args);\n      } catch (error) {\n        ErrorHandler.log(error, context);\n        return null; // Échec silencieux\n      }\n    };\n  }\n\n  /**\n   * Log une erreur (seulement en mode debug ou localhost)\n   * @param {Error} error - Erreur à logger\n   * @param {string} context - Contexte de l'erreur\n   */\n  static log(error, context) {\n    const shouldLog = \n      ErrorHandler.debugMode || \n      window.location.hostname === 'localhost' ||\n      window.location.hostname === '127.0.0.1';\n\n    if (shouldLog) {\n      console.warn(`[PulserSDK - ${context}]`, error);\n    }\n  }\n\n  /**\n   * Active le mode debug\n   */\n  static enableDebug() {\n    ErrorHandler.debugMode = true;\n    console.log('[PulserSDK] Debug mode enabled');\n  }\n\n  /**\n   * Désactive le mode debug\n   */\n  static disableDebug() {\n    ErrorHandler.debugMode = false;\n  }\n}\n\nexport default ErrorHandler;\n","/**\n * StorageManager - Gestion du localStorage\n * Persiste les métadonnées utilisateur et l'historique des campagnes\n */\nimport ErrorHandler from './ErrorHandler.js';\n\nclass StorageManager {\n  constructor() {\n    this.prefix = 'pulser_sdk_';\n    \n    // Clés de stockage\n    this.keys = {\n      userMeta: `${this.prefix}user_meta`,\n      campaignHistory: `${this.prefix}campaign_history`,\n      answeredQuestions: `${this.prefix}answered_questions`,\n      configCache: `${this.prefix}config_cache`,\n      configLastFetch: `${this.prefix}config_last_fetch`,\n      consent: `${this.prefix}consent`\n    };\n  }\n\n  /**\n   * Nettoie une valeur pour éviter les références circulaires\n   * @param {any} value - Valeur à nettoyer\n   * @param {WeakSet} seen - Set pour tracker les objets déjà vus\n   * @returns {any} Valeur nettoyée\n   */\n  _sanitizeValue(value, seen = null) {\n    // Initialiser le WeakSet au premier appel\n    if (!seen) {\n      seen = new WeakSet();\n    }\n\n    if (value === null || value === undefined) {\n      return value;\n    }\n\n    // Types primitifs\n    if (typeof value !== 'object') {\n      return value;\n    }\n\n    // Éléments DOM\n    if (value instanceof Element || value instanceof Node) {\n      return `[DOM Element: ${value.nodeName}]`;\n    }\n\n    // Window/Document\n    if (value === window || value === document) {\n      return '[Window/Document]';\n    }\n\n    // Vérifier si l'objet a déjà été vu (référence circulaire)\n    if (seen.has(value)) {\n      return '[Circular Reference]';\n    }\n\n    // Marquer l'objet comme vu\n    seen.add(value);\n\n    // Tableaux\n    if (Array.isArray(value)) {\n      return value.map(item => this._sanitizeValue(item, seen));\n    }\n\n    // Objets - parcourir manuellement\n    const sanitized = {};\n    for (const key in value) {\n      if (value.hasOwnProperty(key)) {\n        try {\n          if (typeof value[key] === 'function') {\n            continue; // Ignorer les fonctions\n          }\n          sanitized[key] = this._sanitizeValue(value[key], seen);\n        } catch (err) {\n          sanitized[key] = '[Unable to serialize]';\n        }\n      }\n    }\n    return sanitized;\n  }\n\n  // ========== Métadonnées utilisateur ==========\n\n  /**\n   * Stocke une métadonnée utilisateur\n   * @param {string} key - Clé\n   * @param {any} value - Valeur\n   */\n  setUserData(key, value) {\n    try {\n      const userData = this.getAllUserData();\n      // Nettoyer la valeur pour éviter les références circulaires\n      const sanitizedValue = this._sanitizeValue(value);\n      \n      userData[key] = sanitizedValue;\n      \n      // Nettoyer l'objet complet avant stringify pour plus de sécurité\n      const sanitizedUserData = this._sanitizeValue(userData);\n      localStorage.setItem(this.keys.userMeta, JSON.stringify(sanitizedUserData));\n      \n      if (ErrorHandler.debugMode) {\n        console.log('[StorageManager] User data saved (sanitized):', { \n          key, \n          value: sanitizedValue\n        });\n      }\n    } catch (error) {\n      ErrorHandler.log(error, 'StorageManager.setUserData');\n    }\n  }\n\n  /**\n   * Récupère toutes les métadonnées utilisateur\n   * @returns {Object}\n   */\n  getAllUserData() {\n    try {\n      const data = localStorage.getItem(this.keys.userMeta);\n      return data ? JSON.parse(data) : {};\n    } catch (error) {\n      ErrorHandler.log(error, 'StorageManager.getAllUserData');\n      return {};\n    }\n  }\n\n  // ========== Historique des campagnes ==========\n\n  /**\n   * Récupère l'historique d'une campagne\n   * @param {string} campaignId - ID de la campagne\n   * @returns {Object|null}\n   */\n  getCampaignHistory(campaignId) {\n    try {\n      const history = this._getAllCampaignHistory();\n      return history[campaignId] || null;\n    } catch (error) {\n      ErrorHandler.log(error, 'StorageManager.getCampaignHistory');\n      return null;\n    }\n  }\n\n  /**\n   * Marque une campagne comme affichée\n   * @param {string} campaignId - ID de la campagne\n   * @param {string} questionId - ID de la question affichée\n   */\n  markCampaignAsShown(campaignId, questionId) {\n    try {\n      const history = this._getAllCampaignHistory();\n      const now = Date.now();\n      \n      if (!history[campaignId]) {\n        history[campaignId] = {\n          firstShown: now,\n          lastShown: now,\n          shownCount: 1,\n          dismissedCount: 0,\n          answeredCount: 0,\n          lastQuestionId: questionId\n        };\n      } else {\n        history[campaignId].lastShown = now;\n        history[campaignId].shownCount += 1;\n        history[campaignId].lastQuestionId = questionId;\n      }\n      \n      // Nettoyer l'historique avant stringify pour éviter les références circulaires\n      const sanitizedHistory = this._sanitizeValue(history);\n      localStorage.setItem(this.keys.campaignHistory, JSON.stringify(sanitizedHistory));\n      \n      if (ErrorHandler.debugMode) {\n        console.log('[StorageManager] Campaign marked as shown:', { campaignId, questionId });\n      }\n    } catch (error) {\n      ErrorHandler.log(error, 'StorageManager.markCampaignAsShown');\n    }\n  }\n\n  /**\n   * Marque une campagne comme dismissed\n   * @param {string} campaignId - ID de la campagne\n   */\n  markCampaignAsDismissed(campaignId) {\n    try {\n      const history = this._getAllCampaignHistory();\n      \n      if (history[campaignId]) {\n        history[campaignId].dismissedCount += 1;\n        history[campaignId].lastShown = Date.now();\n      }\n      \n      // Nettoyer l'historique avant stringify pour éviter les références circulaires\n      const sanitizedHistory = this._sanitizeValue(history);\n      localStorage.setItem(this.keys.campaignHistory, JSON.stringify(sanitizedHistory));\n      \n      if (ErrorHandler.debugMode) {\n        console.log('[StorageManager] Campaign marked as dismissed:', campaignId);\n      }\n    } catch (error) {\n      ErrorHandler.log(error, 'StorageManager.markCampaignAsDismissed');\n    }\n  }\n\n  /**\n   * Marque une campagne comme answered\n   * @param {string} campaignId - ID de la campagne\n   * @param {string} questionId - ID de la question répondue\n   */\n  markCampaignAsAnswered(campaignId, questionId) {\n    try {\n      const history = this._getAllCampaignHistory();\n      \n      if (history[campaignId]) {\n        history[campaignId].answeredCount += 1;\n        history[campaignId].lastShown = Date.now();\n      }\n      \n      // Nettoyer l'historique avant stringify pour éviter les références circulaires\n      const sanitizedHistory = this._sanitizeValue(history);\n      localStorage.setItem(this.keys.campaignHistory, JSON.stringify(sanitizedHistory));\n      \n      // Stocker le couple (campaignId, questionId)\n      this._storeAnsweredQuestion(campaignId, questionId);\n      \n      if (ErrorHandler.debugMode) {\n        console.log('[StorageManager] Campaign marked as answered:', { campaignId, questionId });\n      }\n    } catch (error) {\n      ErrorHandler.log(error, 'StorageManager.markCampaignAsAnswered');\n    }\n  }\n\n  /**\n   * Vérifie si une campagne peut être affichée selon sa fréquence\n   * @param {string} campaignId - ID de la campagne\n   * @param {number} frequencyDays - Nombre de jours minimum entre deux affichages\n   * @returns {boolean}\n   */\n  canShowCampaign(campaignId, frequencyDays) {\n    if (frequencyDays === 0) return true; // Toujours afficher\n    \n    try {\n      const history = this.getCampaignHistory(campaignId);\n      \n      if (!history || !history.lastShown) {\n        return true; // Jamais affichée\n      }\n      \n      const daysSinceLastShown = (Date.now() - history.lastShown) / (1000 * 60 * 60 * 24);\n      const canShow = daysSinceLastShown >= frequencyDays;\n      \n      if (ErrorHandler.debugMode) {\n        console.log('[StorageManager] Can show campaign?', {\n          campaignId,\n          daysSinceLastShown: daysSinceLastShown.toFixed(2),\n          frequencyDays,\n          canShow\n        });\n      }\n      \n      return canShow;\n    } catch (error) {\n      ErrorHandler.log(error, 'StorageManager.canShowCampaign');\n      return true; // Par défaut, autoriser l'affichage\n    }\n  }\n\n  /**\n   * Récupère tout l'historique des campagnes\n   * @returns {Object}\n   * @private\n   */\n  _getAllCampaignHistory() {\n    try {\n      const data = localStorage.getItem(this.keys.campaignHistory);\n      return data ? JSON.parse(data) : {};\n    } catch (error) {\n      ErrorHandler.log(error, 'StorageManager._getAllCampaignHistory');\n      return {};\n    }\n  }\n\n  // ========== Questions répondues ==========\n\n  /**\n   * Stocke un couple (campaignId, questionId) comme répondu\n   * @param {string} campaignId - ID de la campagne\n   * @param {string} questionId - ID de la question\n   * @private\n   */\n  _storeAnsweredQuestion(campaignId, questionId) {\n    try {\n      const answered = this._getAllAnsweredQuestions();\n      const key = `${campaignId}:${questionId}`;\n      answered[key] = Date.now();\n      \n      // Nettoyer les données avant stringify pour éviter les références circulaires\n      const sanitizedAnswered = this._sanitizeValue(answered);\n      localStorage.setItem(this.keys.answeredQuestions, JSON.stringify(sanitizedAnswered));\n      \n      if (ErrorHandler.debugMode) {\n        console.log('[StorageManager] Question stored as answered:', { campaignId, questionId });\n      }\n    } catch (error) {\n      ErrorHandler.log(error, 'StorageManager._storeAnsweredQuestion');\n    }\n  }\n\n  /**\n   * Vérifie si une question a déjà été répondue\n   * @param {string} campaignId - ID de la campagne\n   * @param {string} questionId - ID de la question\n   * @returns {boolean}\n   */\n  hasAnswered(campaignId, questionId) {\n    try {\n      const answered = this._getAllAnsweredQuestions();\n      const key = `${campaignId}:${questionId}`;\n      return answered[key] !== undefined;\n    } catch (error) {\n      ErrorHandler.log(error, 'StorageManager.hasAnswered');\n      return false;\n    }\n  }\n\n  /**\n   * Récupère toutes les questions répondues\n   * @returns {Object}\n   * @private\n   */\n  _getAllAnsweredQuestions() {\n    try {\n      const data = localStorage.getItem(this.keys.answeredQuestions);\n      return data ? JSON.parse(data) : {};\n    } catch (error) {\n      ErrorHandler.log(error, 'StorageManager._getAllAnsweredQuestions');\n      return {};\n    }\n  }\n\n  // ========== Cache de configuration ==========\n\n  /**\n   * Stocke la configuration en cache\n   * @param {Object} config - Configuration\n   */\n  setCachedConfig(config) {\n    try {\n      // Nettoyer la config pour éviter les références circulaires\n      const sanitizedConfig = this._sanitizeValue(config);\n      localStorage.setItem(this.keys.configCache, JSON.stringify(sanitizedConfig));\n      localStorage.setItem(this.keys.configLastFetch, Date.now().toString());\n      \n      if (ErrorHandler.debugMode) {\n        console.log('[StorageManager] Config cached');\n      }\n    } catch (error) {\n      ErrorHandler.log(error, 'StorageManager.setCachedConfig');\n    }\n  }\n\n  /**\n   * Récupère la configuration en cache\n   * @returns {Object|null}\n   */\n  getCachedConfig() {\n    try {\n      const data = localStorage.getItem(this.keys.configCache);\n      return data ? JSON.parse(data) : null;\n    } catch (error) {\n      ErrorHandler.log(error, 'StorageManager.getCachedConfig');\n      return null;\n    }\n  }\n\n  /**\n   * Récupère la date du dernier fetch\n   * @returns {number|null}\n   */\n  getLastFetchDate() {\n    try {\n      const date = localStorage.getItem(this.keys.configLastFetch);\n      return date ? parseInt(date, 10) : null;\n    } catch (error) {\n      ErrorHandler.log(error, 'StorageManager.getLastFetchDate');\n      return null;\n    }\n  }\n\n  /**\n   * Vérifie si le cache est encore valide\n   * @param {number} ttl - TTL en millisecondes\n   * @returns {boolean}\n   */\n  isCacheValid(ttl) {\n    const lastFetch = this.getLastFetchDate();\n    if (!lastFetch) return false;\n    \n    const age = Date.now() - lastFetch;\n    return age < ttl;\n  }\n\n  // ========== Consentement RGPD ==========\n\n  /**\n   * Récupère le statut du consentement\n   * @returns {boolean|null} - true = accepté, false = refusé, null = pas encore demandé\n   */\n  getConsent() {\n    try {\n      const consent = localStorage.getItem(this.keys.consent);\n      if (consent === null) return null;\n      return consent === 'true';\n    } catch (error) {\n      ErrorHandler.log(error, 'StorageManager.getConsent');\n      return null;\n    }\n  }\n\n  /**\n   * Enregistre le consentement de l'utilisateur\n   * @param {boolean} accepted - true si accepté, false si refusé\n   */\n  setConsent(accepted) {\n    try {\n      localStorage.setItem(this.keys.consent, accepted.toString());\n      \n      if (ErrorHandler.debugMode) {\n        console.log('[StorageManager] Consent saved:', accepted);\n      }\n    } catch (error) {\n      ErrorHandler.log(error, 'StorageManager.setConsent');\n    }\n  }\n\n  /**\n   * Efface le consentement (pour permettre de le redemander)\n   */\n  clearConsent() {\n    try {\n      localStorage.removeItem(this.keys.consent);\n      \n      if (ErrorHandler.debugMode) {\n        console.log('[StorageManager] Consent cleared');\n      }\n    } catch (error) {\n      ErrorHandler.log(error, 'StorageManager.clearConsent');\n    }\n  }\n\n  /**\n   * Efface toutes les réponses (pour conformité RGPD)\n   */\n  clearAllResponses() {\n    try {\n      localStorage.removeItem(this.keys.answeredQuestions);\n      \n      if (ErrorHandler.debugMode) {\n        console.log('[StorageManager] All responses cleared');\n      }\n    } catch (error) {\n      ErrorHandler.log(error, 'StorageManager.clearAllResponses');\n    }\n  }\n\n  /**\n   * Efface toutes les impressions (pour conformité RGPD)\n   */\n  clearAllImpressions() {\n    try {\n      localStorage.removeItem(this.keys.campaignHistory);\n      \n      if (ErrorHandler.debugMode) {\n        console.log('[StorageManager] All impressions cleared');\n      }\n    } catch (error) {\n      ErrorHandler.log(error, 'StorageManager.clearAllImpressions');\n    }\n  }\n\n  // ========== Nettoyage ==========\n\n  /**\n   * Efface toutes les données du SDK\n   */\n  clearAll() {\n    try {\n      Object.values(this.keys).forEach(key => {\n        localStorage.removeItem(key);\n      });\n      \n      if (ErrorHandler.debugMode) {\n        console.log('[StorageManager] All data cleared');\n      }\n    } catch (error) {\n      ErrorHandler.log(error, 'StorageManager.clearAll');\n    }\n  }\n}\n\nexport default StorageManager;","/**\n * ConfigManager - Gestion de la configuration des campagnes\n * Récupère et cache la configuration depuis l'API\n */\nimport ErrorHandler from './ErrorHandler.js';\n\nclass ConfigManager {\n  constructor(domain, language, specificId, storageManager) {\n    this.domain = domain;\n    this.language = language;\n    this.specificId = specificId;\n    this.storageManager = storageManager;\n    \n    // URL de l'API\n    this.apiBaseUrl = `https://api.${domain}/feedback`;\n  }\n\n  /**\n   * Récupère la configuration complète (avec cache intelligent)\n   * @param {boolean} forceRefresh - Si true, ignore le cache et force un fetch\n   * @returns {Promise<Object>} - Configuration complète { campaigns, consent, cacheTTL }\n   */\n  async fetchConfig(forceRefresh = false) {\n    try {\n      // Vérifier le cache (sauf si forceRefresh)\n      if (!forceRefresh) {\n        const cachedConfig = this.storageManager.getCachedConfig();\n        const cacheTTL = cachedConfig?.cacheTTL || (24 * 60 * 60 * 1000); // 24h par défaut\n\n        if (cachedConfig && this.storageManager.isCacheValid(cacheTTL)) {\n          if (ErrorHandler.debugMode) {\n            console.log('[ConfigManager] Using cached config');\n          }\n          return cachedConfig;\n        }\n      } else {\n        if (ErrorHandler.debugMode) {\n          console.log('[ConfigManager] Force refresh requested, ignoring cache');\n        }\n      }\n\n      // Sinon, fetch depuis l'API\n      if (ErrorHandler.debugMode) {\n        console.log('[ConfigManager] Fetching config from API');\n      }\n\n      const config = await this._fetchFromAPI(forceRefresh);\n      \n      if (config) {\n        // Valider et stocker en cache\n        this.storageManager.setCachedConfig(config);\n        return config;\n      }\n\n      // Fallback sur le cache même expiré si le fetch échoue\n      const cachedConfig = this.storageManager.getCachedConfig();\n      if (cachedConfig) {\n        if (ErrorHandler.debugMode) {\n          console.log('[ConfigManager] Using expired cache as fallback');\n        }\n        return cachedConfig;\n      }\n\n      return { campaigns: [], consent: null };\n\n    } catch (error) {\n      ErrorHandler.log(error, 'ConfigManager.fetchConfig');\n      \n      // Fallback sur le cache en cas d'erreur\n      const cachedConfig = this.storageManager.getCachedConfig();\n      return cachedConfig || { campaigns: [], consent: null };\n    }\n  }\n\n  /**\n   * Récupère les campagnes (avec cache intelligent)\n   * Méthode de compatibilité qui retourne uniquement les campagnes\n   * @param {boolean} forceRefresh - Si true, ignore le cache et force un fetch\n   * @returns {Promise<Array>} - Liste des campagnes\n   */\n  async fetchCampaigns(forceRefresh = false) {\n    const config = await this.fetchConfig(forceRefresh);\n    return config.campaigns || [];\n  }\n\n  /**\n   * Effectue la requête HTTP vers l'API\n   * @param {boolean} forceRefresh - Si true, n'envoie pas le header de cache\n   * @returns {Promise<Object|null>}\n   * @private\n   */\n  async _fetchFromAPI(forceRefresh = false) {\n    try {\n      const url = this._buildApiUrl();\n      const headers = this._buildHeaders(forceRefresh);\n\n      if (ErrorHandler.debugMode) {\n        console.log('[ConfigManager] Fetching:', { url, headers });\n      }\n\n      const response = await fetch(url, {\n        method: 'GET',\n        headers: headers,\n        cache: 'no-cache'\n      });\n\n      // HTTP 304 : pas de changement\n      if (response.status === 304) {\n        if (ErrorHandler.debugMode) {\n          console.log('[ConfigManager] Config not modified (304)');\n        }\n        const cachedConfig = this.storageManager.getCachedConfig();\n        return cachedConfig;\n      }\n\n      // HTTP 200 : nouvelle config\n      if (response.ok) {\n        const config = await response.json();\n        \n        if (ErrorHandler.debugMode) {\n          console.log('[ConfigManager] Config fetched successfully:', {\n            campaignsCount: config.campaigns?.length || 0\n          });\n        }\n\n        return config;\n      }\n\n      // Autres codes HTTP\n      console.warn('[ConfigManager] API responded with status:', response.status);\n      return null;\n\n    } catch (error) {\n      ErrorHandler.log(error, 'ConfigManager._fetchFromAPI');\n      return null;\n    }\n  }\n\n  /**\n   * Construit l'URL de l'API\n   * @returns {string}\n   * @private\n   */\n  _buildApiUrl() {\n    let url = `${this.apiBaseUrl}/config?lang=${this.language}`;\n    \n    if (this.specificId) {\n      url += `&id=${this.specificId}`;\n    }\n    \n    return url;\n  }\n\n  /**\n   * Construit les headers HTTP (avec support 304)\n   * @param {boolean} forceRefresh - Si true, n'inclut pas le header de cache\n   * @returns {Object}\n   * @private\n   */\n  _buildHeaders(forceRefresh = false) {\n    const headers = {\n      'Content-Type': 'application/json',\n      'Accept': 'application/json'\n    };\n\n    // Ajouter le header pour la validation HTTP 304 (sauf si forceRefresh)\n    if (!forceRefresh) {\n      const lastFetchDate = this.storageManager.getLastFetchDate();\n      if (lastFetchDate) {\n        headers['X-Last-Fetch-Date'] = lastFetchDate.toString();\n      }\n    }\n\n    return headers;\n  }\n}\n\nexport default ConfigManager;","/**\n * DecisionEngine - Moteur de décision pour afficher ou non une campagne\n * Gère la priorité, fréquence, regex URL, et facteur de chance\n */\nimport ErrorHandler from './ErrorHandler.js';\n\nclass DecisionEngine {\n  constructor(storageManager) {\n    this.storageManager = storageManager;\n  }\n\n  /**\n   * Trouve une campagne éligible pour l'URL courante\n   * @param {Array} campaigns - Liste des campagnes\n   * @param {string} currentUrl - URL actuelle\n   * @returns {Object|null} - Campagne éligible avec une question sélectionnée, ou null\n   */\n  findEligibleCampaign(campaigns, currentUrl) {\n    try {\n      const now = Date.now();\n      \n      if (ErrorHandler.debugMode) {\n        console.log('[DecisionEngine] Evaluating campaigns:', {\n          campaignsCount: campaigns.length,\n          currentUrl\n        });\n      }\n\n      // Filtrer les campagnes actives (dates valides)\n      const activeCampaigns = campaigns.filter(campaign => {\n        const isActive = now >= campaign.startDate && now <= campaign.endDate;\n        \n        if (ErrorHandler.debugMode && !isActive) {\n          console.log('[DecisionEngine] Campaign not active:', {\n            id: campaign.id,\n            startDate: new Date(campaign.startDate).toISOString(),\n            endDate: new Date(campaign.endDate).toISOString()\n          });\n        }\n        \n        return isActive;\n      });\n\n      if (activeCampaigns.length === 0) {\n        if (ErrorHandler.debugMode) {\n          console.log('[DecisionEngine] No active campaigns');\n        }\n        return null;\n      }\n\n      // Filtrer par URL (allowList et blockList au niveau de la campagne)\n      const urlEligibleCampaigns = activeCampaigns.filter(campaign => {\n        return this._isUrlEligible(campaign, currentUrl);\n      });\n\n      if (urlEligibleCampaigns.length === 0) {\n        if (ErrorHandler.debugMode) {\n          console.log('[DecisionEngine] No campaigns match URL filters');\n        }\n        return null;\n      }\n\n      // Filtrer par fréquence\n      const frequencyEligibleCampaigns = urlEligibleCampaigns.filter(campaign => {\n        return this.storageManager.canShowCampaign(\n          campaign.id,\n          campaign.frequencyDays || 0\n        );\n      });\n\n      if (frequencyEligibleCampaigns.length === 0) {\n        if (ErrorHandler.debugMode) {\n          console.log('[DecisionEngine] No campaigns pass frequency check');\n        }\n        return null;\n      }\n\n      // Trier par priorité (plus haute = plus importante)\n      const sortedCampaigns = frequencyEligibleCampaigns.sort((a, b) => {\n        return (b.priority || 0) - (a.priority || 0);\n      });\n\n      // Appliquer le facteur de chance sur la campagne la plus prioritaire\n      for (const campaign of sortedCampaigns) {\n        const luckFactor = campaign.luckFactor !== undefined ? campaign.luckFactor : 1;\n        const random = Math.random();\n        \n        if (ErrorHandler.debugMode) {\n          console.log('[DecisionEngine] Testing campaign luck:', {\n            campaignId: campaign.id,\n            luckFactor,\n            random: random.toFixed(3),\n            passes: random <= luckFactor\n          });\n        }\n\n        if (random <= luckFactor) {\n          // Sélectionner une question de la campagne\n          const selectedQuestion = this._selectQuestionFromCampaign(campaign);\n          \n          if (selectedQuestion) {\n            if (ErrorHandler.debugMode) {\n              console.log('[DecisionEngine] Campaign selected:', {\n                campaignId: campaign.id,\n                questionId: selectedQuestion.id\n              });\n            }\n            \n            return {\n              campaign: campaign,\n              question: selectedQuestion\n            };\n          }\n        }\n      }\n\n      if (ErrorHandler.debugMode) {\n        console.log('[DecisionEngine] No campaign passed luck factor');\n      }\n\n      return null;\n\n    } catch (error) {\n      ErrorHandler.log(error, 'DecisionEngine.findEligibleCampaign');\n      return null;\n    }\n  }\n\n  /**\n   * Vérifie si l'URL correspond aux filtres de la campagne\n   * @param {Object} campaign - Campagne\n   * @param {string} url - URL à vérifier\n   * @returns {boolean}\n   * @private\n   */\n  _isUrlEligible(campaign, url) {\n    try {\n      const path = new URL(url).pathname;\n\n      // Vérifier la blockList d'abord (prioritaire)\n      if (campaign.blockListRegex && campaign.blockListRegex.length > 0) {\n        for (const pattern of campaign.blockListRegex) {\n          const regex = new RegExp(pattern);\n          if (regex.test(path)) {\n            if (ErrorHandler.debugMode) {\n              console.log('[DecisionEngine] URL blocked by campaign:', {\n                campaignId: campaign.id,\n                pattern,\n                path\n              });\n            }\n            return false;\n          }\n        }\n      }\n\n      // Vérifier l'allowList (si présente)\n      if (campaign.allowListRegex && campaign.allowListRegex.length > 0) {\n        for (const pattern of campaign.allowListRegex) {\n          const regex = new RegExp(pattern);\n          if (regex.test(path)) {\n            return true;\n          }\n        }\n        // Si allowList existe mais aucun match, rejeter\n        if (ErrorHandler.debugMode) {\n          console.log('[DecisionEngine] URL not in allowList for campaign:', {\n            campaignId: campaign.id,\n            path\n          });\n        }\n        return false;\n      }\n\n      // Pas de filtres ou seulement blockList (déjà passé) = OK\n      return true;\n\n    } catch (error) {\n      ErrorHandler.log(error, 'DecisionEngine._isUrlEligible');\n      return false;\n    }\n  }\n\n  /**\n   * Sélectionne une question parmi celles de la campagne\n   * Filtre les questions déjà répondues, puis sélection aléatoire\n   * @param {Object} campaign - Campagne\n   * @returns {Object|null} - Question sélectionnée\n   * @private\n   */\n  _selectQuestionFromCampaign(campaign) {\n    try {\n      if (!campaign.questions || campaign.questions.length === 0) {\n        if (ErrorHandler.debugMode) {\n          console.log('[DecisionEngine] Campaign has no questions:', campaign.id);\n        }\n        return null;\n      }\n\n      // Filtrer les questions non-répondues\n      const unansweredQuestions = campaign.questions.filter(question => {\n        const hasAnswered = this.storageManager.hasAnswered(campaign.id, question.id);\n        \n        if (hasAnswered && ErrorHandler.debugMode) {\n          console.log('[DecisionEngine] Question already answered, skipping:', {\n            campaignId: campaign.id,\n            questionId: question.id\n          });\n        }\n        \n        return !hasAnswered;\n      });\n\n      if (unansweredQuestions.length === 0) {\n        if (ErrorHandler.debugMode) {\n          console.log('[DecisionEngine] All questions answered for campaign:', campaign.id);\n        }\n        return null;\n      }\n\n      // Sélection aléatoire parmi les questions non-répondues\n      const randomIndex = Math.floor(Math.random() * unansweredQuestions.length);\n      const selectedQuestion = unansweredQuestions[randomIndex];\n\n      if (ErrorHandler.debugMode) {\n        console.log('[DecisionEngine] Question selected:', {\n          campaignId: campaign.id,\n          questionId: selectedQuestion.id,\n          totalQuestions: campaign.questions.length,\n          unansweredQuestions: unansweredQuestions.length\n        });\n      }\n\n      return selectedQuestion;\n\n    } catch (error) {\n      ErrorHandler.log(error, 'DecisionEngine._selectQuestionFromCampaign');\n      return null;\n    }\n  }\n}\n\nexport default DecisionEngine;","/**\n * DataSubmitter - Envoi des données vers l'API\n * Gère les réponses et les impressions\n */\nimport ErrorHandler from './ErrorHandler.js';\n\nclass DataSubmitter {\n  constructor(domain) {\n    this.domain = domain;\n    this.apiBaseUrl = `https://api.${domain}/feedback`;\n  }\n\n  /**\n   * Nettoie un objet pour éviter les références circulaires\n   * @param {any} obj - Objet à nettoyer\n   * @param {WeakSet} seen - Set pour tracker les objets déjà vus\n   * @returns {any} Objet nettoyé\n   */\n  _sanitizeData(obj, seen = null) {\n    // Initialiser le WeakSet au premier appel\n    if (!seen) {\n      seen = new WeakSet();\n    }\n\n    if (obj === null || obj === undefined) {\n      return obj;\n    }\n\n    // Si c'est un type primitif, on le retourne tel quel\n    if (typeof obj !== 'object') {\n      return obj;\n    }\n\n    // Si c'est un élément DOM, on le convertit en string\n    if (obj instanceof Element || obj instanceof Node) {\n      return `[DOM Element: ${obj.nodeName}]`;\n    }\n\n    // Si c'est window ou document\n    if (obj === window || obj === document) {\n      return '[Window/Document]';\n    }\n\n    // Vérifier si l'objet a déjà été vu (référence circulaire)\n    if (seen.has(obj)) {\n      return '[Circular Reference]';\n    }\n\n    // Marquer l'objet comme vu\n    seen.add(obj);\n\n    // Si c'est un tableau\n    if (Array.isArray(obj)) {\n      return obj.map(item => this._sanitizeData(item, seen));\n    }\n\n    // Si c'est un objet, on parcourt ses propriétés\n    const sanitized = {};\n\n    for (const key in obj) {\n      if (obj.hasOwnProperty(key)) {\n        try {\n          const value = obj[key];\n          \n          // Ignorer les fonctions\n          if (typeof value === 'function') {\n            continue;\n          }\n\n          sanitized[key] = this._sanitizeData(value, seen);\n        } catch (e) {\n          sanitized[key] = '[Unable to serialize]';\n        }\n      }\n    }\n\n    return sanitized;\n  }\n\n  /**\n   * Envoie une réponse utilisateur\n   * @param {string} campaignId - ID de la campagne\n   * @param {string} questionId - ID de la question\n   * @param {any} answer - Réponse de l'utilisateur\n   * @param {Object} metadata - Métadonnées additionnelles\n   * @returns {Promise<boolean>}\n   */\n  async submitAnswer(campaignId, questionId, answer, metadata = {}) {\n    try {\n      // Nettoyer les métadonnées pour éviter les références circulaires\n      const sanitizedMetadata = this._sanitizeData(metadata);\n      \n      const payload = {\n        campaignId,\n        questionId,\n        answer,\n        metadata: sanitizedMetadata,\n        timestamp: Date.now(),\n        url: window.location.href,\n        userAgent: navigator.userAgent\n      };\n\n      // Nettoyer le payload entier avant stringify pour éviter les erreurs de circularité\n      const sanitizedPayload = this._sanitizeData(payload);\n\n      if (ErrorHandler.debugMode) {\n        console.log('[DataSubmitter] Submitting answer:', sanitizedPayload);\n      }\n\n      const response = await fetch(`${this.apiBaseUrl}/submit`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json'\n        },\n        body: JSON.stringify(sanitizedPayload)\n      });\n\n      if (response.ok) {\n        if (ErrorHandler.debugMode) {\n          console.log('[DataSubmitter] Answer submitted successfully');\n        }\n        return true;\n      } else {\n        console.warn('[DataSubmitter] Submit failed with status:', response.status);\n        return false;\n      }\n\n    } catch (error) {\n      ErrorHandler.log(error, 'DataSubmitter.submitAnswer');\n      return false;\n    }\n  }\n\n  /**\n   * Envoie une impression (dismiss)\n   * @param {string} campaignId - ID de la campagne\n   * @param {string} questionId - ID de la question\n   * @param {Object} metadata - Métadonnées additionnelles\n   * @returns {Promise<boolean>}\n   */\n  async submitImpression(campaignId, questionId, metadata = {}) {\n    try {\n      // Nettoyer les métadonnées pour éviter les références circulaires\n      const sanitizedMetadata = this._sanitizeData(metadata);\n      \n      const payload = {\n        campaignId,\n        questionId,\n        metadata: sanitizedMetadata,\n        timestamp: Date.now(),\n        url: window.location.href,\n        userAgent: navigator.userAgent\n      };\n\n      // Nettoyer le payload entier avant stringify pour éviter les erreurs de circularité\n      const sanitizedPayload = this._sanitizeData(payload);\n\n      if (ErrorHandler.debugMode) {\n        console.log('[DataSubmitter] Submitting impression:', sanitizedPayload);\n      }\n\n      const response = await fetch(`${this.apiBaseUrl}/impression`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json'\n        },\n        body: JSON.stringify(sanitizedPayload)\n      });\n\n      if (response.ok) {\n        if (ErrorHandler.debugMode) {\n          console.log('[DataSubmitter] Impression submitted successfully');\n        }\n        return true;\n      } else {\n        console.warn('[DataSubmitter] Impression failed with status:', response.status);\n        return false;\n      }\n\n    } catch (error) {\n      ErrorHandler.log(error, 'DataSubmitter.submitImpression');\n      return false;\n    }\n  }\n}\n\nexport default DataSubmitter;","/**\n * NavigationMonitor - Détection de navigation SPA\n * Approche hybride : événements natifs + polling de secours\n * Zéro interférence avec le site hôte\n */\nimport ErrorHandler from './ErrorHandler.js';\n\nclass NavigationMonitor {\n  constructor(onNavigate) {\n    this.onNavigate = onNavigate;\n    this.currentUrl = window.location.href;\n    this.listeners = [];\n    this.pollingInterval = null;\n    this.isActive = false;\n  }\n\n  /**\n   * Démarre la surveillance de navigation\n   * @param {number} pollingIntervalMs - Intervalle de polling (défaut: 2000ms)\n   */\n  start(pollingIntervalMs = 2000) {\n    if (this.isActive) {\n      if (ErrorHandler.debugMode) {\n        console.warn('[NavigationMonitor] Already started');\n      }\n      return;\n    }\n\n    this.isActive = true;\n    \n    // 1. Écoute des événements natifs\n    this._listenToNativeEvents();\n    \n    // 2. Polling de secours\n    this._startPolling(pollingIntervalMs);\n\n    if (ErrorHandler.debugMode) {\n      console.log('[NavigationMonitor] Started', {\n        pollingInterval: pollingIntervalMs\n      });\n    }\n  }\n\n  /**\n   * Arrête la surveillance\n   */\n  stop() {\n    if (!this.isActive) return;\n\n    // Cleanup événements\n    this.listeners.forEach(([target, event, handler, options]) => {\n      target.removeEventListener(event, handler, options);\n    });\n    this.listeners = [];\n    \n    // Cleanup polling\n    if (this.pollingInterval) {\n      clearInterval(this.pollingInterval);\n      this.pollingInterval = null;\n    }\n\n    this.isActive = false;\n\n    if (ErrorHandler.debugMode) {\n      console.log('[NavigationMonitor] Stopped');\n    }\n  }\n\n  /**\n   * Écoute les événements natifs du navigateur\n   */\n  _listenToNativeEvents() {\n    // 1. Navigation arrière/avant (History API)\n    const popStateHandler = () => this._checkUrlChange();\n    window.addEventListener('popstate', popStateHandler);\n    this.listeners.push([window, 'popstate', popStateHandler]);\n\n    // 2. Navigation par hash (#)\n    const hashChangeHandler = () => this._checkUrlChange();\n    window.addEventListener('hashchange', hashChangeHandler);\n    this.listeners.push([window, 'hashchange', hashChangeHandler]);\n\n    // 3. Clics sur liens (détection anticipée)\n    const clickHandler = (e) => {\n      const link = e.target.closest('a');\n      if (link && link.href && link.href !== '#') {\n        // Délai pour laisser le router SPA faire son travail\n        setTimeout(() => this._checkUrlChange(), 100);\n      }\n    };\n    document.addEventListener('click', clickHandler, true);\n    this.listeners.push([document, 'click', clickHandler, true]);\n\n    // 4. Soumission de formulaires (peut changer l'URL)\n    const submitHandler = () => {\n      setTimeout(() => this._checkUrlChange(), 100);\n    };\n    document.addEventListener('submit', submitHandler, true);\n    this.listeners.push([document, 'submit', submitHandler, true]);\n  }\n\n  /**\n   * Démarre le polling de secours\n   * @param {number} interval - Intervalle en ms\n   */\n  _startPolling(interval) {\n    this.pollingInterval = setInterval(() => {\n      this._checkUrlChange();\n    }, interval);\n  }\n\n  /**\n   * Vérifie si l'URL a changé et déclenche le callback\n   */\n  _checkUrlChange() {\n    const newUrl = window.location.href;\n    \n    if (newUrl !== this.currentUrl) {\n      if (ErrorHandler.debugMode) {\n        console.log('[NavigationMonitor] URL changed:', {\n          from: this.currentUrl,\n          to: newUrl\n        });\n      }\n\n      this.currentUrl = newUrl;\n      \n      // Appel du callback avec gestion d'erreur\n      ErrorHandler.wrap(() => {\n        this.onNavigate(newUrl);\n      }, 'NavigationMonitor.onNavigate')();\n    }\n  }\n\n  /**\n   * Force une vérification immédiate\n   */\n  checkNow() {\n    this._checkUrlChange();\n  }\n}\n\nexport default NavigationMonitor;\n","/**\n * ValidationManager - Validation des réponses utilisateur\n * Gère les règles de validation et les messages d'erreur\n */\nimport ErrorHandler from './ErrorHandler.js';\n\nclass ValidationManager {\n  /**\n   * Valide une réponse selon les règles configurées\n   * @param {any} answer - Réponse à valider\n   * @param {Object} question - Configuration de la question\n   * @returns {Object} { valid: boolean, errors: string[] }\n   */\n  static validate(answer, question) {\n    try {\n      const { type, responseConfig = {}, validation = {} } = question;\n      const errors = [];\n\n      // Si pas de règles de validation, considérer comme valide\n      if (!validation || Object.keys(validation).length === 0) {\n        return { valid: true, errors: [] };\n      }\n\n      // Validation selon le type de question\n      switch (type) {\n        case 'textarea':\n          this._validateTextarea(answer, validation, errors);\n          break;\n        \n        case 'select':\n        case 'dropdown':\n          this._validateSelect(answer, validation, errors);\n          break;\n        \n        case 'rating':\n        case 'nps':\n        case 'scale':\n          this._validateNumeric(answer, validation, errors);\n          break;\n        \n        case 'boolean':\n          this._validateBoolean(answer, validation, errors);\n          break;\n        \n        default:\n          // Validation générique\n          this._validateGeneric(answer, validation, errors);\n      }\n\n      // Validateur personnalisé (si fourni)\n      if (validation.custom && typeof validation.custom === 'function') {\n        const customResult = validation.custom(answer);\n        if (customResult !== true && typeof customResult === 'string') {\n          errors.push(customResult);\n        }\n      }\n\n      return {\n        valid: errors.length === 0,\n        errors\n      };\n\n    } catch (error) {\n      ErrorHandler.log(error, 'ValidationManager.validate');\n      // En cas d'erreur de validation, considérer comme valide pour ne pas bloquer l'utilisateur\n      return { valid: true, errors: [] };\n    }\n  }\n\n  /**\n   * Valide un champ textarea\n   * @private\n   */\n  static _validateTextarea(answer, validation, errors) {\n    if (answer === null || answer === undefined || answer === '') {\n      if (validation.required !== false) { // required par défaut\n        errors.push(validation.requiredMessage || 'Ce champ est requis');\n      }\n      return;\n    }\n\n    const text = String(answer);\n    \n    // Longueur minimale\n    if (validation.minLength !== undefined && text.length < validation.minLength) {\n      errors.push(\n        validation.minLengthMessage || \n        `La réponse doit contenir au moins ${validation.minLength} caractères`\n      );\n    }\n\n    // Longueur maximale\n    if (validation.maxLength !== undefined && text.length > validation.maxLength) {\n      errors.push(\n        validation.maxLengthMessage || \n        `La réponse ne doit pas dépasser ${validation.maxLength} caractères`\n      );\n    }\n\n    // Pattern (regex)\n    if (validation.pattern) {\n      const regex = new RegExp(validation.pattern);\n      if (!regex.test(text)) {\n        errors.push(\n          validation.patternMessage || \n          'Le format de la réponse est incorrect'\n        );\n      }\n    }\n\n    // Mots interdits\n    if (validation.forbiddenWords && Array.isArray(validation.forbiddenWords)) {\n      const lowerText = text.toLowerCase();\n      const foundForbidden = validation.forbiddenWords.filter(word => \n        lowerText.includes(word.toLowerCase())\n      );\n      \n      if (foundForbidden.length > 0) {\n        errors.push(\n          validation.forbiddenWordsMessage || \n          `Votre réponse contient des mots non autorisés : ${foundForbidden.join(', ')}`\n        );\n      }\n    }\n  }\n\n  /**\n   * Valide un champ select/dropdown\n   * @private\n   */\n  static _validateSelect(answer, validation, errors) {\n    if (answer === null || answer === undefined || answer === '') {\n      if (validation.required !== false) {\n        errors.push(validation.requiredMessage || 'Veuillez sélectionner une option');\n      }\n      return;\n    }\n\n    // Valeurs interdites\n    if (validation.forbiddenValues && Array.isArray(validation.forbiddenValues)) {\n      if (validation.forbiddenValues.includes(answer)) {\n        errors.push(\n          validation.forbiddenValuesMessage || \n          'Cette option n\\'est pas autorisée'\n        );\n      }\n    }\n  }\n\n  /**\n   * Valide un champ numérique (rating, nps, scale)\n   * @private\n   */\n  static _validateNumeric(answer, validation, errors) {\n    if (answer === null || answer === undefined) {\n      if (validation.required !== false) {\n        errors.push(validation.requiredMessage || 'Veuillez sélectionner une valeur');\n      }\n      return;\n    }\n\n    const num = Number(answer);\n\n    // Valeur minimale\n    if (validation.min !== undefined && num < validation.min) {\n      errors.push(\n        validation.minMessage || \n        `La valeur minimale est ${validation.min}`\n      );\n    }\n\n    // Valeur maximale\n    if (validation.max !== undefined && num > validation.max) {\n      errors.push(\n        validation.maxMessage || \n        `La valeur maximale est ${validation.max}`\n      );\n    }\n\n    // Valeurs interdites\n    if (validation.forbiddenValues && Array.isArray(validation.forbiddenValues)) {\n      if (validation.forbiddenValues.includes(num)) {\n        errors.push(\n          validation.forbiddenValuesMessage || \n          'Cette valeur n\\'est pas autorisée'\n        );\n      }\n    }\n  }\n\n  /**\n   * Valide un champ boolean\n   * @private\n   */\n  static _validateBoolean(answer, validation, errors) {\n    if (answer === null || answer === undefined) {\n      if (validation.required !== false) {\n        errors.push(validation.requiredMessage || 'Veuillez faire un choix');\n      }\n      return;\n    }\n\n    // Valeur forcée (ex: forcer \"Oui\" pour un consentement)\n    if (validation.mustBeTrue && answer !== true) {\n      errors.push(\n        validation.mustBeTrueMessage || \n        'Vous devez accepter pour continuer'\n      );\n    }\n\n    if (validation.mustBeFalse && answer !== false) {\n      errors.push(\n        validation.mustBeFalseMessage || \n        'Vous devez refuser pour continuer'\n      );\n    }\n  }\n\n  /**\n   * Validation générique\n   * @private\n   */\n  static _validateGeneric(answer, validation, errors) {\n    if (answer === null || answer === undefined || answer === '') {\n      if (validation.required !== false) {\n        errors.push(validation.requiredMessage || 'Ce champ est requis');\n      }\n    }\n  }\n\n  /**\n   * Valide en temps réel (pour affichage d'erreurs pendant la saisie)\n   * Retourne seulement les erreurs \"en cours de saisie\" (pas les erreurs de champ vide)\n   * @param {any} answer - Réponse à valider\n   * @param {Object} question - Configuration de la question\n   * @returns {Object} { valid: boolean, errors: string[] }\n   */\n  static validateLive(answer, question) {\n    try {\n      const { type, validation = {} } = question;\n      const errors = [];\n\n      // Ne pas valider les champs vides en temps réel (attendre le submit)\n      if (answer === null || answer === undefined || answer === '') {\n        return { valid: true, errors: [] };\n      }\n\n      switch (type) {\n        case 'textarea':\n          const text = String(answer);\n          \n          // Longueur maximale\n          if (validation.maxLength !== undefined && text.length > validation.maxLength) {\n            errors.push(\n              validation.maxLengthMessage || \n              `La réponse ne doit pas dépasser ${validation.maxLength} caractères`\n            );\n          }\n\n          // Pattern\n          if (validation.pattern) {\n            const regex = new RegExp(validation.pattern);\n            if (!regex.test(text)) {\n              errors.push(\n                validation.patternMessage || \n                'Le format de la réponse est incorrect'\n              );\n            }\n          }\n\n          // Mots interdits\n          if (validation.forbiddenWords && Array.isArray(validation.forbiddenWords)) {\n            const lowerText = text.toLowerCase();\n            const foundForbidden = validation.forbiddenWords.filter(word => \n              lowerText.includes(word.toLowerCase())\n            );\n            \n            if (foundForbidden.length > 0) {\n              errors.push(\n                validation.forbiddenWordsMessage || \n                `Mots non autorisés : ${foundForbidden.join(', ')}`\n              );\n            }\n          }\n          break;\n      }\n\n      return {\n        valid: errors.length === 0,\n        errors\n      };\n\n    } catch (error) {\n      ErrorHandler.log(error, 'ValidationManager.validateLive');\n      return { valid: true, errors: [] };\n    }\n  }\n}\n\nexport default ValidationManager;\n","/**\n * UIRenderer - Rendu de l'interface utilisateur avec Shadow DOM\n * Utilise Container Queries pour la responsivité\n */\nimport ErrorHandler from './ErrorHandler.js';\nimport ValidationManager from './ValidationManager.js';\n\nclass UIRenderer {\n  constructor(onSubmit, onDismiss, position = 'bottom-right') {\n    this.shadowHost = null;\n    this.shadowRoot = null;\n    this.isVisible = false;\n    this.currentQuestion = null;\n    this.position = position;\n    \n    // Callbacks\n    this.onSubmit = onSubmit;\n    this.onDismiss = onDismiss;\n  }\n\n  /**\n   * Crée le conteneur Shadow DOM\n   */\n  createShadowContainer() {\n    if (this.shadowHost) return; // Déjà créé\n\n    try {\n      // IMPORTANT : Vérifier et supprimer tout pulser-sdk-host existant dans le DOM\n      // Cela garantit qu'il n'y a toujours qu'un seul host dans le DOM (comportement singleton)\n      const existingHost = document.getElementById('pulser-sdk-host');\n      if (existingHost) {\n        existingHost.parentNode.removeChild(existingHost);\n        if (ErrorHandler.debugMode) {\n          console.log('[UIRenderer] Removed existing pulser-sdk-host from DOM (ensuring singleton)');\n        }\n      }\n\n      // Créer l'élément hôte\n      this.shadowHost = document.createElement('div');\n      this.shadowHost.id = 'pulser-sdk-host';\n      this.shadowHost.setAttribute('data-pulser-sdk', 'true');\n      \n      // Attacher le Shadow DOM\n      this.shadowRoot = this.shadowHost.attachShadow({ mode: 'closed' });\n      \n      // Injecter les styles\n      const styleSheet = document.createElement('style');\n      styleSheet.textContent = this._getStyles();\n      this.shadowRoot.appendChild(styleSheet);\n      \n      // Créer le conteneur principal (caché par défaut)\n      const container = document.createElement('div');\n      container.id = 'feedback-container';\n      container.className = 'feedback-hidden';\n      this.shadowRoot.appendChild(container);\n      \n      // Ajouter au DOM\n      document.body.appendChild(this.shadowHost);\n\n      if (ErrorHandler.debugMode) {\n        console.log('[UIRenderer] Shadow DOM created');\n      }\n\n    } catch (error) {\n      ErrorHandler.log(error, 'UIRenderer.createShadowContainer');\n    }\n  }\n\n  /**\n   * Rend une question dans le widget\n   * @param {Object} question - Question à afficher\n   * @param {Object} campaign - Campagne associée (optionnel)\n   */\n  renderQuestion(question, campaign = null) {\n    if (!this.shadowRoot) {\n      this.createShadowContainer();\n    }\n\n    try {\n      this.currentQuestion = question;\n      this.currentCampaign = campaign;\n      const container = this.shadowRoot.getElementById('feedback-container');\n      \n      if (!container) return;\n\n      container.innerHTML = this._generateQuestionHTML(question);\n      this._attachEventListeners();\n\n      if (ErrorHandler.debugMode) {\n        console.log('[UIRenderer] Question rendered:', question.id);\n      }\n\n    } catch (error) {\n      ErrorHandler.log(error, 'UIRenderer.renderQuestion');\n    }\n  }\n\n  /**\n   * Rend l'écran de consentement RGPD\n   * @param {Object} consentConfig - Configuration du consentement\n   * @param {Function} onConsent - Callback appelé avec true/false selon la réponse\n   */\n  renderConsent(consentConfig, onConsent) {\n    if (!this.shadowRoot) {\n      this.createShadowContainer();\n    }\n\n    try {\n      const container = this.shadowRoot.getElementById('feedback-container');\n      if (!container) return;\n\n      container.innerHTML = this._generateConsentHTML(consentConfig);\n      this._attachConsentEventListeners(onConsent);\n\n      if (ErrorHandler.debugMode) {\n        console.log('[UIRenderer] Consent screen rendered');\n      }\n\n    } catch (error) {\n      ErrorHandler.log(error, 'UIRenderer.renderConsent');\n    }\n  }\n\n  /**\n   * Affiche le widget\n   */\n  show() {\n    if (!this.shadowRoot) return;\n\n    try {\n      const container = this.shadowRoot.getElementById('feedback-container');\n      if (container) {\n        container.classList.remove('feedback-hidden');\n        container.classList.add('feedback-visible');\n        this.isVisible = true;\n\n        if (ErrorHandler.debugMode) {\n          console.log('[UIRenderer] Widget shown');\n        }\n      }\n    } catch (error) {\n      ErrorHandler.log(error, 'UIRenderer.show');\n    }\n  }\n\n  /**\n   * Cache le widget\n   */\n  hide() {\n    if (!this.shadowRoot) return;\n\n    try {\n      const container = this.shadowRoot.getElementById('feedback-container');\n      if (container) {\n        container.classList.remove('feedback-visible');\n        container.classList.add('feedback-hidden');\n        this.isVisible = false;\n\n        if (ErrorHandler.debugMode) {\n          console.log('[UIRenderer] Widget hidden');\n        }\n      }\n    } catch (error) {\n      ErrorHandler.log(error, 'UIRenderer.hide');\n    }\n  }\n\n  /**\n   * Détruit le widget\n   */\n  destroy() {\n    if (this.shadowHost && this.shadowHost.parentNode) {\n      this.shadowHost.parentNode.removeChild(this.shadowHost);\n      this.shadowHost = null;\n      this.shadowRoot = null;\n      this.isVisible = false;\n\n      if (ErrorHandler.debugMode) {\n        console.log('[UIRenderer] Widget destroyed');\n      }\n    }\n  }\n\n  /**\n   * Génère le HTML de la question\n   * @param {Object} question - Question\n   * @returns {string}\n   */\n  _generateQuestionHTML(question) {\n    // Déterminer si on doit masquer le bouton d'envoi (auto-submit)\n    const shouldAutoSubmit = this._shouldAutoSubmit(question);\n    \n    return `\n      <div class=\"feedback-widget\">\n        <div class=\"feedback-header\">\n          <h3 class=\"feedback-title\">${this._escapeHtml(question.title)}</h3>\n          <button type=\"button\" id=\"feedback-close\" class=\"feedback-close\" aria-label=\"Fermer\">\n            <svg width=\"16\" height=\"16\" viewBox=\"0 0 16 16\" fill=\"none\">\n              <path d=\"M12 4L4 12M4 4L12 12\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\"/>\n            </svg>\n          </button>\n        </div>\n        \n        ${question.assistiveText ? `\n          <p class=\"feedback-assistive\">${this._escapeHtml(question.assistiveText)}</p>\n        ` : ''}\n        \n        <form id=\"feedback-form\" class=\"feedback-form\">\n          ${this._generateInputField(question)}\n          ${shouldAutoSubmit ? '' : '<button type=\"submit\" class=\"feedback-submit\">Envoyer</button>'}\n        </form>\n      </div>\n    `;\n  }\n\n  /**\n   * Génère le champ de saisie selon le type\n   * @param {Object} question - Question\n   * @returns {string}\n   */\n  _generateInputField(question) {\n    const { type, responseConfig = {} } = question;\n\n    switch (type) {\n      case 'textarea':\n        return this._renderTextarea(responseConfig);\n      \n      case 'rating':\n        return this._renderRating(responseConfig);\n      \n      case 'boolean':\n        return this._renderBoolean(responseConfig);\n      \n      case 'nps':\n        return this._renderNPS(responseConfig);\n      \n      case 'scale':\n        return this._renderScale(responseConfig);\n      \n      case 'select':\n      case 'dropdown':\n        return this._renderSelect(responseConfig);\n      \n      default:\n        return this._renderTextarea(responseConfig);\n    }\n  }\n\n  /**\n   * Rend un champ textarea\n   * @param {Object} config - Configuration\n   * @returns {string}\n   */\n  _renderTextarea(config) {\n    const maxChars = config.maxChars || 500;\n    const placeholder = config.placeholder || 'Votre réponse...';\n    \n    return `\n      <textarea \n        name=\"answer\" \n        class=\"feedback-textarea\" \n        maxlength=\"${maxChars}\"\n        placeholder=\"${this._escapeHtml(placeholder)}\"\n        required\n      ></textarea>\n      <div class=\"feedback-char-count\">\n        <span class=\"char-current\">0</span> / ${maxChars}\n      </div>\n    `;\n  }\n\n  /**\n   * Rend un système de rating (étoiles)\n   * @param {Object} config - Configuration\n   * @returns {string}\n   */\n  _renderRating(config) {\n    const max = config.max || 5;\n    const labels = config.labels || {};\n    \n    let html = '<div class=\"feedback-rating\">';\n    \n    for (let i = 1; i <= max; i++) {\n      html += `\n        <label class=\"feedback-rating-item\">\n          <input type=\"radio\" name=\"rating\" value=\"${i}\" required>\n          <span class=\"feedback-star\">★</span>\n          ${labels[i] ? `<span class=\"feedback-rating-label\">${this._escapeHtml(labels[i])}</span>` : ''}\n        </label>\n      `;\n    }\n    \n    html += '</div>';\n    return html;\n  }\n\n  /**\n   * Rend un choix boolean (Oui/Non)\n   * @param {Object} config - Configuration\n   * @returns {string}\n   */\n  _renderBoolean(config) {\n    const yesLabel = config.yesLabel || 'Oui';\n    const noLabel = config.noLabel || 'Non';\n    \n    return `\n      <div class=\"feedback-boolean\">\n        <label class=\"feedback-boolean-item\">\n          <input type=\"radio\" name=\"boolean\" value=\"true\" required>\n          <span class=\"feedback-boolean-label\">${this._escapeHtml(yesLabel)}</span>\n        </label>\n        <label class=\"feedback-boolean-item\">\n          <input type=\"radio\" name=\"boolean\" value=\"false\" required>\n          <span class=\"feedback-boolean-label\">${this._escapeHtml(noLabel)}</span>\n        </label>\n      </div>\n    `;\n  }\n\n  /**\n   * Rend un NPS (0-10)\n   * @param {Object} config - Configuration\n   * @returns {string}\n   */\n  _renderNPS(config) {\n    const minLabel = config.minLabel || 'Pas du tout probable';\n    const maxLabel = config.maxLabel || 'Très probable';\n    \n    let html = '<div class=\"feedback-nps\">';\n    html += `<div class=\"feedback-nps-labels\">\n      <span>${this._escapeHtml(minLabel)}</span>\n      <span>${this._escapeHtml(maxLabel)}</span>\n    </div>`;\n    html += '<div class=\"feedback-nps-scale\">';\n    \n    for (let i = 0; i <= 10; i++) {\n      html += `\n        <label class=\"feedback-nps-item\">\n          <input type=\"radio\" name=\"nps\" value=\"${i}\" required>\n          <span class=\"feedback-nps-number\">${i}</span>\n        </label>\n      `;\n    }\n    \n    html += '</div></div>';\n    return html;\n  }\n\n  /**\n   * Rend une échelle personnalisée\n   * @param {Object} config - Configuration\n   * @returns {string}\n   */\n  _renderScale(config) {\n    const min = config.min || 1;\n    const max = config.max || 10;\n    \n    let html = '<div class=\"feedback-scale\">';\n    \n    for (let i = min; i <= max; i++) {\n      html += `\n        <label class=\"feedback-scale-item\">\n          <input type=\"radio\" name=\"scale\" value=\"${i}\" required>\n          <span class=\"feedback-scale-number\">${i}</span>\n        </label>\n      `;\n    }\n    \n    html += '</div>';\n    return html;\n  }\n\n  /**\n   * Rend une liste déroulante (select)\n   * @param {Object} config - Configuration\n   * @returns {string}\n   */\n  _renderSelect(config) {\n    const options = config.options || [];\n    const placeholder = config.placeholder || 'Sélectionnez une option...';\n    const allowCustom = config.allowCustom || false;\n    \n    let html = '<div class=\"feedback-select-wrapper\">';\n    html += `\n      <select name=\"select\" class=\"feedback-select\" required>\n        <option value=\"\" disabled selected>${this._escapeHtml(placeholder)}</option>\n    `;\n    \n    options.forEach(option => {\n      const value = typeof option === 'string' ? option : option.value;\n      const label = typeof option === 'string' ? option : option.label || option.value;\n      html += `<option value=\"${this._escapeHtml(value)}\">${this._escapeHtml(label)}</option>`;\n    });\n    \n    // Option \"Autre\" si allowCustom est activé\n    if (allowCustom) {\n      html += `<option value=\"__custom__\">Autre...</option>`;\n    }\n    \n    html += '</select>';\n    \n    // Champ texte pour réponse personnalisée (caché par défaut)\n    if (allowCustom) {\n      html += `\n        <input \n          type=\"text\" \n          name=\"customAnswer\" \n          class=\"feedback-custom-input feedback-custom-hidden\" \n          placeholder=\"Votre réponse...\"\n          maxlength=\"200\"\n        />\n      `;\n    }\n    \n    html += '</div>';\n    return html;\n  }\n\n  /**\n   * Attache les événements sur le formulaire\n   */\n  _attachEventListeners() {\n    const form = this.shadowRoot.getElementById('feedback-form');\n    const closeBtn = this.shadowRoot.getElementById('feedback-close');\n\n    // Submit du formulaire\n    if (form) {\n      form.addEventListener('submit', (e) => {\n        e.preventDefault();\n        this._submitAnswer();\n      });\n    }\n\n    // Fermeture manuelle\n    if (closeBtn) {\n      closeBtn.addEventListener('click', () => {\n        ErrorHandler.wrap(() => {\n          this.onDismiss(this.currentQuestion.id);\n        }, 'UIRenderer.onDismiss')();\n        this.hide();\n      });\n    }\n\n    // Compteur de caractères pour textarea + validation en temps réel\n    const textarea = this.shadowRoot.querySelector('textarea');\n    if (textarea) {\n      const charCurrent = this.shadowRoot.querySelector('.char-current');\n      textarea.addEventListener('input', () => {\n        if (charCurrent) {\n          charCurrent.textContent = textarea.value.length;\n        }\n        \n        // Validation en temps réel\n        if (this.currentQuestion.validation) {\n          const answer = textarea.value.trim();\n          const validationResult = ValidationManager.validateLive(answer, this.currentQuestion);\n          \n          if (!validationResult.valid) {\n            this._showValidationErrors(validationResult.errors);\n          } else {\n            this._clearValidationErrors();\n          }\n        }\n      });\n    }\n\n    // Gestion du select avec option \"Autre\"\n    const select = this.shadowRoot.querySelector('select[name=\"select\"]');\n    const customInput = this.shadowRoot.querySelector('input[name=\"customAnswer\"]');\n    if (select && customInput) {\n      select.addEventListener('change', () => {\n        if (select.value === '__custom__') {\n          customInput.classList.remove('feedback-custom-hidden');\n          customInput.required = true;\n          customInput.focus();\n        } else {\n          customInput.classList.add('feedback-custom-hidden');\n          customInput.required = false;\n          customInput.value = '';\n        }\n      });\n    }\n\n    // Auto-submit pour les types de questions appropriés\n    if (this._shouldAutoSubmit(this.currentQuestion)) {\n      this._attachAutoSubmitListeners();\n    }\n\n    // Effet hover sur rating\n    this._attachRatingHoverEffect();\n  }\n\n  /**\n   * Effet visuel au hover sur les étoiles\n   */\n  _attachRatingHoverEffect() {\n    const ratingInputs = this.shadowRoot.querySelectorAll('.feedback-rating-item input');\n    const ratingStars = this.shadowRoot.querySelectorAll('.feedback-star');\n    \n    ratingInputs.forEach((input, index) => {\n      input.addEventListener('mouseenter', () => {\n        ratingStars.forEach((star, i) => {\n          if (i <= index) {\n            star.classList.add('hovered');\n          } else {\n            star.classList.remove('hovered');\n          }\n        });\n      });\n\n      input.addEventListener('change', () => {\n        ratingStars.forEach((star, i) => {\n          if (i <= index) {\n            star.classList.add('selected');\n          } else {\n            star.classList.remove('selected');\n          }\n        });\n      });\n    });\n\n    const ratingContainer = this.shadowRoot.querySelector('.feedback-rating');\n    if (ratingContainer) {\n      ratingContainer.addEventListener('mouseleave', () => {\n        ratingStars.forEach(star => star.classList.remove('hovered'));\n      });\n    }\n  }\n\n  /**\n   * Extrait la réponse du formulaire\n   * @returns {any}\n   */\n  _extractAnswer() {\n    const type = this.currentQuestion.type;\n    \n    switch (type) {\n      case 'textarea':\n        const textarea = this.shadowRoot.querySelector('textarea');\n        return textarea ? textarea.value.trim() : null;\n      \n      case 'rating':\n        const rating = this.shadowRoot.querySelector('input[name=\"rating\"]:checked');\n        return rating ? parseInt(rating.value, 10) : null;\n      \n      case 'boolean':\n        const bool = this.shadowRoot.querySelector('input[name=\"boolean\"]:checked');\n        return bool ? bool.value === 'true' : null;\n      \n      case 'nps':\n        const nps = this.shadowRoot.querySelector('input[name=\"nps\"]:checked');\n        return nps ? parseInt(nps.value, 10) : null;\n      \n      case 'scale':\n        const scale = this.shadowRoot.querySelector('input[name=\"scale\"]:checked');\n        return scale ? parseInt(scale.value, 10) : null;\n      \n      case 'select':\n      case 'dropdown':\n        const select = this.shadowRoot.querySelector('select[name=\"select\"]');\n        if (!select) return null;\n        \n        // Si l'option \"Autre\" est sélectionnée, retourner la réponse personnalisée\n        if (select.value === '__custom__') {\n          const customInput = this.shadowRoot.querySelector('input[name=\"customAnswer\"]');\n          return customInput ? customInput.value.trim() : null;\n        }\n        \n        return select.value || null;\n      \n      default:\n        return null;\n    }\n  }\n\n  /**\n   * Détermine si la question doit utiliser l'auto-submit\n   * @param {Object} question - Question\n   * @returns {boolean}\n   */\n  _shouldAutoSubmit(question) {\n    const { type, responseConfig = {} } = question;\n    \n    // Si la config force explicitement le bouton, on désactive l'auto-submit\n    if (responseConfig.requireSubmitButton === true) {\n      return false;\n    }\n    \n    // Par défaut, auto-submit pour NPS, rating, boolean et scale\n    // Select/dropdown nécessite toujours un bouton\n    return ['nps', 'rating', 'boolean', 'scale'].includes(type);\n  }\n\n  /**\n   * Attache les listeners pour l'auto-submit\n   */\n  _attachAutoSubmitListeners() {\n    const inputs = this.shadowRoot.querySelectorAll('input[type=\"radio\"]');\n    \n    inputs.forEach(input => {\n      input.addEventListener('change', () => {\n        // Petit délai pour permettre l'animation visuelle\n        setTimeout(() => {\n          this._submitAnswer();\n        }, 300);\n      });\n    });\n\n    if (ErrorHandler.debugMode) {\n      console.log('[UIRenderer] Auto-submit listeners attached');\n    }\n  }\n\n  /**\n   * Soumet la réponse (factorisation du code de submit)\n   */\n  _submitAnswer() {\n    const answer = this._extractAnswer();\n    \n    if (answer !== null) {\n      // Valider la réponse avant soumission\n      const validationResult = ValidationManager.validate(answer, this.currentQuestion);\n      \n      if (!validationResult.valid) {\n        // Afficher les erreurs de validation\n        this._showValidationErrors(validationResult.errors);\n        \n        if (ErrorHandler.debugMode) {\n          console.warn('[UIRenderer] Validation failed:', validationResult.errors);\n        }\n        return;\n      }\n\n      // Nettoyer les erreurs précédentes\n      this._clearValidationErrors();\n\n      ErrorHandler.wrap(() => {\n        this.onSubmit(this.currentQuestion.id, answer);\n      }, 'UIRenderer.onSubmit')();\n      \n      // Afficher le message de remerciement si configuré\n      this._showThankYouMessage();\n    }\n  }\n\n  /**\n   * Affiche le message de remerciement si configuré\n   */\n  _showThankYouMessage() {\n    const thankYouConfig = this.currentQuestion.thankYouMessage || this.currentCampaign?.thankYouMessage;\n    \n    if (!thankYouConfig || !thankYouConfig.enabled) {\n      this.hide();\n      return;\n    }\n\n    // Gérer les tableaux de messages (choix aléatoire)\n    let messageText = thankYouConfig.text || 'Merci pour votre réponse !';\n    const isArray = Array.isArray(messageText);\n    if (isArray) {\n      if (messageText.length === 0) {\n        messageText = 'Merci pour votre réponse !';\n      } else {\n        const randomIndex = Math.floor(Math.random() * messageText.length);\n        messageText = messageText[randomIndex];\n        \n        if (ErrorHandler.debugMode) {\n          console.log('[UIRenderer] Random message selected from array:', { \n            index: randomIndex, \n            totalMessages: thankYouConfig.text.length,\n            selectedMessage: messageText \n          });\n        }\n      }\n    }\n\n    const message = messageText;\n    const duration = thankYouConfig.duration || 2000;\n\n    // Remplacer le contenu du widget par le message de remerciement\n    const widget = this.shadowRoot.querySelector('.feedback-widget');\n    if (widget) {\n      widget.innerHTML = `\n        <div class=\"feedback-thankyou\">\n          <div class=\"feedback-thankyou-icon\">\n            <svg width=\"48\" height=\"48\" viewBox=\"0 0 48 48\" fill=\"none\">\n              <circle cx=\"24\" cy=\"24\" r=\"20\" fill=\"#10b981\" opacity=\"0.1\"/>\n              <path d=\"M14 24l8 8 16-16\" stroke=\"#10b981\" stroke-width=\"3\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/>\n            </svg>\n          </div>\n          <p class=\"feedback-thankyou-message\">${this._escapeHtml(message)}</p>\n        </div>\n      `;\n    }\n\n    // Auto-fermer après la durée configurée\n    setTimeout(() => {\n      this.hide();\n    }, duration);\n\n    if (ErrorHandler.debugMode) {\n      console.log('[UIRenderer] Thank you message displayed:', { message, duration, wasArray: isArray });\n    }\n  }\n\n  /**\n   * Affiche les erreurs de validation\n   * @param {string[]} errors - Liste des messages d'erreur\n   */\n  _showValidationErrors(errors) {\n    if (!errors || errors.length === 0) return;\n\n    // Nettoyer les erreurs précédentes\n    this._clearValidationErrors();\n\n    // Créer le conteneur d'erreurs\n    const form = this.shadowRoot.getElementById('feedback-form');\n    if (!form) return;\n\n    const errorContainer = document.createElement('div');\n    errorContainer.className = 'feedback-validation-errors';\n    errorContainer.innerHTML = errors.map(error => `\n      <div class=\"feedback-validation-error\">\n        <svg width=\"16\" height=\"16\" viewBox=\"0 0 16 16\" fill=\"none\">\n          <circle cx=\"8\" cy=\"8\" r=\"7\" stroke=\"#ef4444\" stroke-width=\"1.5\"/>\n          <path d=\"M8 4v5M8 11h.01\" stroke=\"#ef4444\" stroke-width=\"1.5\" stroke-linecap=\"round\"/>\n        </svg>\n        <span>${this._escapeHtml(error)}</span>\n      </div>\n    `).join('');\n\n    // Insérer au début du formulaire\n    form.insertBefore(errorContainer, form.firstChild);\n\n    if (ErrorHandler.debugMode) {\n      console.log('[UIRenderer] Validation errors displayed:', errors);\n    }\n  }\n\n  /**\n   * Efface les erreurs de validation\n   */\n  _clearValidationErrors() {\n    const errorContainer = this.shadowRoot.querySelector('.feedback-validation-errors');\n    if (errorContainer) {\n      errorContainer.remove();\n    }\n  }\n\n  /**\n   * Génère le HTML de l'écran de consentement\n   * @param {Object} config - Configuration du consentement\n   * @returns {string}\n   */\n  _generateConsentHTML(config) {\n    return `\n      <div class=\"feedback-widget feedback-consent-widget\">\n        <div class=\"feedback-header\">\n          <h3 class=\"feedback-title\">${this._escapeHtml(config.title)}</h3>\n          <button type=\"button\" id=\"feedback-close\" class=\"feedback-close\" aria-label=\"Fermer\">\n            <svg width=\"16\" height=\"16\" viewBox=\"0 0 16 16\" fill=\"none\">\n              <path d=\"M12 4L4 12M4 4L12 12\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\"/>\n            </svg>\n          </button>\n        </div>\n        \n        <div class=\"feedback-consent-content\">\n          <p class=\"feedback-consent-description\">${this._escapeHtml(config.description)}</p>\n          \n          ${config.learnMoreUrl ? `\n            <a href=\"${this._escapeHtml(config.learnMoreUrl)}\" \n               target=\"_blank\" \n               rel=\"noopener noreferrer\" \n               class=\"feedback-consent-learn-more\">\n              ${this._escapeHtml(config.learnMoreText)}\n              <svg width=\"12\" height=\"12\" viewBox=\"0 0 12 12\" fill=\"none\">\n                <path d=\"M3 9L9 3M9 3H4M9 3v5\" stroke=\"currentColor\" stroke-width=\"1.5\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/>\n              </svg>\n            </a>\n          ` : ''}\n          \n          <div class=\"feedback-consent-data-info\">\n            <div class=\"feedback-consent-data-icon\">\n              <svg width=\"20\" height=\"20\" viewBox=\"0 0 20 20\" fill=\"none\">\n                <circle cx=\"10\" cy=\"10\" r=\"8\" stroke=\"#6b7280\" stroke-width=\"1.5\"/>\n                <path d=\"M10 7v5M10 13h.01\" stroke=\"#6b7280\" stroke-width=\"1.5\" stroke-linecap=\"round\"/>\n              </svg>\n            </div>\n            <p class=\"feedback-consent-data-text\">${this._escapeHtml(config.dataCollectionInfo)}</p>\n          </div>\n          \n          ${config.privacyPolicyUrl ? `\n            <a href=\"${this._escapeHtml(config.privacyPolicyUrl)}\" \n               target=\"_blank\" \n               rel=\"noopener noreferrer\" \n               class=\"feedback-consent-privacy-link\">\n              Politique de confidentialité\n            </a>\n          ` : ''}\n        </div>\n        \n        <div class=\"feedback-consent-actions\">\n          <button type=\"button\" id=\"feedback-consent-accept\" class=\"feedback-consent-button feedback-consent-accept\">\n            ${this._escapeHtml(config.acceptLabel)}\n          </button>\n          <button type=\"button\" id=\"feedback-consent-decline\" class=\"feedback-consent-button feedback-consent-decline\">\n            ${this._escapeHtml(config.declineLabel)}\n          </button>\n        </div>\n      </div>\n    `;\n  }\n\n  /**\n   * Attache les écouteurs d'événements pour l'écran de consentement\n   * @param {Function} onConsent - Callback appelé avec true/false\n   */\n  _attachConsentEventListeners(onConsent) {\n    // Bouton fermer\n    const closeButton = this.shadowRoot.getElementById('feedback-close');\n    if (closeButton) {\n      closeButton.addEventListener('click', () => {\n        this.hide();\n        if (this.onDismiss) {\n          this.onDismiss('consent_dismissed');\n        }\n      });\n    }\n\n    // Bouton accepter\n    const acceptButton = this.shadowRoot.getElementById('feedback-consent-accept');\n    if (acceptButton) {\n      acceptButton.addEventListener('click', () => {\n        if (ErrorHandler.debugMode) {\n          console.log('[UIRenderer] Consent accepted');\n        }\n        onConsent(true);\n      });\n    }\n\n    // Bouton refuser\n    const declineButton = this.shadowRoot.getElementById('feedback-consent-decline');\n    if (declineButton) {\n      declineButton.addEventListener('click', () => {\n        if (ErrorHandler.debugMode) {\n          console.log('[UIRenderer] Consent declined');\n        }\n        onConsent(false);\n      });\n    }\n  }\n\n  /**\n   * Échappe le HTML pour éviter XSS\n   * @param {string} text - Texte à échapper\n   * @returns {string}\n   */\n  _escapeHtml(text) {\n    const div = document.createElement('div');\n    div.textContent = text;\n    return div.innerHTML;\n  }\n\n  /**\n   * Retourne la configuration CSS selon la position\n   */\n  _getPositionConfig() {\n    const pos = this.position || 'bottom-right';\n    const margin = '20px';\n    \n    const configs = {\n      // BOTTOM-RIGHT : Point de référence = coin bas-droit\n      'bottom-right': {\n        css: `bottom: ${margin}; right: ${margin};`,\n        hidden: 'translateY(20px) scale(0.95)',\n        visible: 'translateY(0) scale(1)'\n      },\n      // BOTTOM-LEFT : Point de référence = coin bas-gauche\n      'bottom-left': {\n        css: `bottom: ${margin}; left: ${margin};`,\n        hidden: 'translateY(20px) scale(0.95)',\n        visible: 'translateY(0) scale(1)'\n      },\n      // TOP-RIGHT : Point de référence = coin haut-droit\n      'top-right': {\n        css: `top: ${margin}; right: ${margin};`,\n        hidden: 'translateY(-20px) scale(0.95)',\n        visible: 'translateY(0) scale(1)'\n      },\n      // TOP-LEFT : Point de référence = coin haut-gauche\n      'top-left': {\n        css: `top: ${margin}; left: ${margin};`,\n        hidden: 'translateY(-20px) scale(0.95)',\n        visible: 'translateY(0) scale(1)'\n      },\n      // TOP-CENTER : Point de référence = centre-haut\n      'top-center': {\n        css: `top: ${margin}; left: 50%;`,\n        hidden: 'translate(-50%, -20px) scale(0.95)',\n        visible: 'translate(-50%, 0) scale(1)'\n      },\n      // BOTTOM-CENTER : Point de référence = centre-bas\n      'bottom-center': {\n        css: `bottom: ${margin}; left: 50%;`,\n        hidden: 'translate(-50%, 20px) scale(0.95)',\n        visible: 'translate(-50%, 0) scale(1)'\n      },\n      // MIDDLE-RIGHT : Point de référence = centre-droit\n      'middle-right': {\n        css: `top: 50%; right: ${margin};`,\n        hidden: 'translate(20px, -50%) scale(0.95)',\n        visible: 'translate(0, -50%) scale(1)'\n      },\n      // MIDDLE-LEFT : Point de référence = centre-gauche\n      'middle-left': {\n        css: `top: 50%; left: ${margin};`,\n        hidden: 'translate(-20px, -50%) scale(0.95)',\n        visible: 'translate(0, -50%) scale(1)'\n      },\n      // CENTER : Point de référence = centre absolu\n      'center': {\n        css: `top: 50%; left: 50%;`,\n        hidden: 'translate(-50%, -50%) scale(0.95)',\n        visible: 'translate(-50%, -50%) scale(1)'\n      }\n    };\n\n    return configs[pos] || configs['bottom-right'];\n  }\n\n  /**\n   * Retourne les styles CSS avec Container Queries\n   * @returns {string}\n   */\n  _getStyles() {\n    const posConfig = this._getPositionConfig();\n\n    return `\n      /* Reset */\n      * {\n        box-sizing: border-box;\n        margin: 0;\n        padding: 0;\n      }\n\n      /* Container */\n      #feedback-container {\n        position: fixed;\n        ${posConfig.css}\n        z-index: 999999;\n        font-family: -apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto, \"Helvetica Neue\", Arial, sans-serif;\n        transition: opacity 0.3s ease, transform 0.3s ease;\n        width: auto;\n        max-width: 100vw;\n      }\n\n      #feedback-container.feedback-hidden {\n        opacity: 0;\n        transform: ${posConfig.hidden};\n        pointer-events: none;\n      }\n\n      #feedback-container.feedback-visible {\n        opacity: 1;\n        transform: ${posConfig.visible};\n      }\n\n      /* Widget Principal */\n      .feedback-widget {\n        background: white;\n        border-radius: 12px;\n        box-shadow: 0 4px 24px rgba(0, 0, 0, 0.15);\n        padding: 20px;\n        width: 380px;\n        max-width: 380px;\n        min-width: 280px;\n      }\n\n      /* MOBILE RESPONSIVE - Force fullwidth en bas sur mobile */\n      @media (max-width: 768px) {\n        #feedback-container {\n          position: fixed !important;\n          bottom: 0 !important;\n          left: 0 !important;\n          right: 0 !important;\n          top: auto !important;\n          transform: none !important;\n          padding: 0 12px 12px 12px;\n        }\n\n        #feedback-container.feedback-hidden {\n          transform: translateY(100%) !important;\n          opacity: 0;\n        }\n\n        #feedback-container.feedback-visible {\n          transform: translateY(0) !important;\n          opacity: 1;\n        }\n\n        .feedback-widget {\n          width: 100%;\n          max-width: 100%;\n          min-width: 100%;\n          border-bottom-left-radius: 0;\n          border-bottom-right-radius: 0;\n          box-shadow: 0 -4px 24px rgba(0, 0, 0, 0.15);\n        }\n      }\n\n      /* TABLET - Réduction progressive */\n      @media (max-width: 1024px) and (min-width: 769px) {\n        .feedback-widget {\n          width: 340px;\n          max-width: 340px;\n        }\n      }\n\n      /* DESKTOP - Assurer que le container sur les positions centrées prend la bonne largeur */\n      @media (min-width: 769px) {\n        #feedback-container {\n          width: max-content;\n        }\n      }\n\n      /* Header */\n      .feedback-header {\n        display: flex;\n        justify-content: space-between;\n        align-items: flex-start;\n        margin-bottom: 12px;\n      }\n\n      .feedback-title {\n        font-size: 16px;\n        font-weight: 600;\n        color: #1a1a1a;\n        line-height: 1.4;\n        margin: 0;\n        padding-right: 8px;\n      }\n\n      .feedback-close {\n        background: none;\n        border: none;\n        cursor: pointer;\n        padding: 4px;\n        color: #666;\n        transition: color 0.2s;\n        flex-shrink: 0;\n      }\n\n      .feedback-close:hover {\n        color: #000;\n      }\n\n      .feedback-assistive {\n        font-size: 14px;\n        color: #666;\n        margin-bottom: 16px;\n        line-height: 1.5;\n      }\n\n      /* Form */\n      .feedback-form {\n        display: flex;\n        flex-direction: column;\n        gap: 16px;\n      }\n\n      /* Textarea */\n      .feedback-textarea {\n        width: 100%;\n        min-height: 80px;\n        padding: 12px;\n        border: 1px solid #ddd;\n        border-radius: 8px;\n        font-family: inherit;\n        font-size: 14px;\n        resize: vertical;\n        transition: border-color 0.2s;\n      }\n\n      .feedback-textarea:focus {\n        outline: none;\n        border-color: #0066ff;\n      }\n\n      .feedback-char-count {\n        font-size: 12px;\n        color: #999;\n        text-align: right;\n      }\n\n      /* Rating (Étoiles) */\n      .feedback-rating {\n        display: flex;\n        gap: 8px;\n        justify-content: center;\n      }\n\n      .feedback-rating-item {\n        cursor: pointer;\n        display: flex;\n        flex-direction: column;\n        align-items: center;\n        gap: 4px;\n      }\n\n      .feedback-rating-item input {\n        position: absolute;\n        opacity: 0;\n      }\n\n      .feedback-star {\n        font-size: 32px;\n        color: #ddd;\n        transition: color 0.2s;\n      }\n\n      .feedback-star.hovered,\n      .feedback-star.selected {\n        color: #ffc107;\n      }\n\n      .feedback-rating-label {\n        font-size: 11px;\n        color: #666;\n      }\n\n      /* Boolean */\n      .feedback-boolean {\n        display: flex;\n        gap: 12px;\n      }\n\n      .feedback-boolean-item {\n        flex: 1;\n        cursor: pointer;\n      }\n\n      .feedback-boolean-item input {\n        position: absolute;\n        opacity: 0;\n      }\n\n      .feedback-boolean-label {\n        display: block;\n        padding: 12px;\n        border: 2px solid #ddd;\n        border-radius: 8px;\n        text-align: center;\n        font-size: 14px;\n        font-weight: 500;\n        transition: all 0.2s;\n      }\n\n      .feedback-boolean-item input:checked + .feedback-boolean-label {\n        border-color: #0066ff;\n        background: #f0f7ff;\n        color: #0066ff;\n      }\n\n      /* NPS */\n      .feedback-nps {\n        display: flex;\n        flex-direction: column;\n        gap: 8px;\n      }\n\n      .feedback-nps-labels {\n        display: flex;\n        justify-content: space-between;\n        font-size: 11px;\n        color: #666;\n      }\n\n      .feedback-nps-scale {\n        display: flex;\n        gap: 4px;\n        justify-content: space-between;\n      }\n\n      .feedback-nps-item {\n        flex: 1;\n        cursor: pointer;\n      }\n\n      .feedback-nps-item input {\n        position: absolute;\n        opacity: 0;\n      }\n\n      .feedback-nps-number {\n        display: block;\n        padding: 8px 4px;\n        border: 1px solid #ddd;\n        border-radius: 6px;\n        text-align: center;\n        font-size: 13px;\n        font-weight: 500;\n        transition: all 0.2s;\n      }\n\n      .feedback-nps-item input:checked + .feedback-nps-number {\n        border-color: #0066ff;\n        background: #0066ff;\n        color: white;\n      }\n\n      /* Scale */\n      .feedback-scale {\n        display: flex;\n        gap: 6px;\n        flex-wrap: wrap;\n        justify-content: center;\n      }\n\n      .feedback-scale-item {\n        cursor: pointer;\n      }\n\n      .feedback-scale-item input {\n        position: absolute;\n        opacity: 0;\n      }\n\n      .feedback-scale-number {\n        display: block;\n        width: 40px;\n        height: 40px;\n        line-height: 40px;\n        border: 1px solid #ddd;\n        border-radius: 6px;\n        text-align: center;\n        font-size: 14px;\n        font-weight: 500;\n        transition: all 0.2s;\n      }\n\n      .feedback-scale-item input:checked + .feedback-scale-number {\n        border-color: #0066ff;\n        background: #0066ff;\n        color: white;\n      }\n\n      /* Select / Dropdown */\n      .feedback-select-wrapper {\n        display: flex;\n        flex-direction: column;\n        gap: 12px;\n      }\n\n      .feedback-select {\n        width: 100%;\n        padding: 10px 12px;\n        border: 2px solid #ddd;\n        border-radius: 6px;\n        font-family: inherit;\n        font-size: 15px;\n        color: #333;\n        background-color: white;\n        cursor: pointer;\n        transition: border-color 0.2s;\n      }\n\n      .feedback-select:hover {\n        border-color: #999;\n      }\n\n      .feedback-select:focus {\n        outline: 2px solid #0066ff;\n        outline-offset: 2px;\n        border-color: #0066ff;\n      }\n\n      .feedback-select:disabled {\n        background: #f5f5f5;\n        color: #999;\n        cursor: not-allowed;\n      }\n\n      .feedback-select option {\n        color: #333;\n        background-color: white;\n        padding: 8px;\n      }\n\n      .feedback-custom-input {\n        width: 100%;\n        padding: 10px 12px;\n        border: 2px solid #ddd;\n        border-radius: 6px;\n        font-family: inherit;\n        font-size: 15px;\n        color: #333;\n        background-color: white;\n        transition: border-color 0.2s, opacity 0.2s, max-height 0.3s;\n      }\n\n      .feedback-custom-input:hover {\n        border-color: #999;\n      }\n\n      .feedback-custom-input:focus {\n        outline: 2px solid #0066ff;\n        outline-offset: 2px;\n        border-color: #0066ff;\n      }\n\n      .feedback-custom-hidden {\n        display: none;\n      }\n\n      /* Consent Screen */\n      .feedback-consent-widget {\n        max-width: 450px;\n      }\n\n      .feedback-consent-content {\n        padding: 0 24px 20px 24px;\n        display: flex;\n        flex-direction: column;\n        gap: 16px;\n      }\n\n      .feedback-consent-description {\n        font-size: 15px;\n        line-height: 1.6;\n        color: #374151;\n        margin: 0;\n      }\n\n      .feedback-consent-learn-more {\n        display: inline-flex;\n        align-items: center;\n        gap: 4px;\n        color: #0066ff;\n        text-decoration: none;\n        font-size: 14px;\n        font-weight: 500;\n        transition: color 0.2s;\n      }\n\n      .feedback-consent-learn-more:hover {\n        color: #0052cc;\n        text-decoration: underline;\n      }\n\n      .feedback-consent-data-info {\n        display: flex;\n        gap: 12px;\n        padding: 14px;\n        background: #f9fafb;\n        border: 1px solid #e5e7eb;\n        border-radius: 8px;\n      }\n\n      .feedback-consent-data-icon {\n        flex-shrink: 0;\n      }\n\n      .feedback-consent-data-text {\n        font-size: 13px;\n        line-height: 1.5;\n        color: #6b7280;\n        margin: 0;\n      }\n\n      .feedback-consent-privacy-link {\n        display: inline-block;\n        color: #6b7280;\n        text-decoration: underline;\n        font-size: 13px;\n        transition: color 0.2s;\n      }\n\n      .feedback-consent-privacy-link:hover {\n        color: #374151;\n      }\n\n      .feedback-consent-actions {\n        display: flex;\n        flex-direction: column;\n        gap: 10px;\n        padding: 0 24px 24px 24px;\n      }\n\n      .feedback-consent-button {\n        width: 100%;\n        padding: 12px 24px;\n        border: none;\n        border-radius: 8px;\n        font-size: 14px;\n        font-weight: 600;\n        cursor: pointer;\n        transition: all 0.2s;\n      }\n\n      .feedback-consent-accept {\n        background: #0066ff;\n        color: white;\n      }\n\n      .feedback-consent-accept:hover {\n        background: #0052cc;\n      }\n\n      .feedback-consent-decline {\n        background: #f3f4f6;\n        color: #6b7280;\n      }\n\n      .feedback-consent-decline:hover {\n        background: #e5e7eb;\n        color: #374151;\n      }\n\n      .feedback-consent-button:active {\n        transform: scale(0.98);\n      }\n\n      /* Validation Errors */\n      .feedback-validation-errors {\n        display: flex;\n        flex-direction: column;\n        gap: 8px;\n        margin-bottom: 12px;\n      }\n\n      .feedback-validation-error {\n        display: flex;\n        align-items: flex-start;\n        gap: 8px;\n        padding: 10px 12px;\n        background: #fef2f2;\n        border: 1px solid #fecaca;\n        border-radius: 6px;\n        font-size: 13px;\n        color: #dc2626;\n        line-height: 1.4;\n      }\n\n      .feedback-validation-error svg {\n        flex-shrink: 0;\n        margin-top: 1px;\n      }\n\n      .feedback-validation-error span {\n        flex: 1;\n      }\n\n      /* Submit Button */\n      .feedback-submit {\n        background: #0066ff;\n        color: white;\n        border: none;\n        padding: 12px;\n        border-radius: 8px;\n        font-size: 14px;\n        font-weight: 600;\n        cursor: pointer;\n        transition: background 0.2s;\n      }\n\n      .feedback-submit:hover {\n        background: #0052cc;\n      }\n\n      .feedback-submit:active {\n        transform: scale(0.98);\n      }\n\n      .feedback-submit:disabled {\n        background: #ccc;\n        cursor: not-allowed;\n      }\n\n      /* Thank You Message */\n      .feedback-thankyou {\n        display: flex;\n        flex-direction: column;\n        align-items: center;\n        justify-content: center;\n        text-align: center;\n        padding: 32px 24px;\n        min-height: 200px;\n      }\n\n      .feedback-thankyou-icon {\n        margin-bottom: 16px;\n        animation: thankYouScale 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);\n      }\n\n      @keyframes thankYouScale {\n        0% {\n          transform: scale(0);\n          opacity: 0;\n        }\n        100% {\n          transform: scale(1);\n          opacity: 1;\n        }\n      }\n\n      .feedback-thankyou-message {\n        font-size: 16px;\n        font-weight: 500;\n        color: #333;\n        margin: 0;\n        line-height: 1.5;\n        animation: thankYouFadeIn 0.4s ease-out 0.2s both;\n      }\n\n      @keyframes thankYouFadeIn {\n        0% {\n          opacity: 0;\n          transform: translateY(10px);\n        }\n        100% {\n          opacity: 1;\n          transform: translateY(0);\n        }\n      }\n\n      /* Container Queries - Responsive - Pour desktop uniquement */\n      @media (min-width: 769px) {\n        @container feedback (max-width: 320px) {\n          .feedback-widget {\n            padding: 16px;\n            max-width: 100%;\n          }\n\n          .feedback-title {\n            font-size: 14px;\n          }\n\n          .feedback-star {\n            font-size: 24px;\n          }\n\n          .feedback-nps-scale {\n            gap: 2px;\n          }\n\n          .feedback-nps-number {\n            font-size: 11px;\n            padding: 6px 2px;\n          }\n        }\n\n        @container feedback (min-width: 400px) {\n          .feedback-widget {\n            padding: 24px;\n          }\n\n          .feedback-title {\n            font-size: 18px;\n          }\n        }\n      }\n\n      /* Mobile optimizations - Petits ajustements */\n      @media (max-width: 768px) {\n        .feedback-star {\n          font-size: 28px;\n        }\n\n        .feedback-rating {\n          gap: 6px;\n        }\n\n        .feedback-nps-scale {\n          gap: 3px;\n        }\n\n        .feedback-nps-number {\n          font-size: 12px;\n          padding: 6px 2px;\n        }\n\n        .feedback-nps-labels {\n          font-size: 10px;\n        }\n      }\n    `;\n  }\n}\n\nexport default UIRenderer;","/**\n * ConsentManager - Gestion du consentement RGPD\n * Gère l'affichage et le stockage du consentement utilisateur\n */\nimport ErrorHandler from './ErrorHandler.js';\n\nclass ConsentManager {\n  constructor(storageManager) {\n    this.storageManager = storageManager;\n    this.config = null;\n  }\n\n  /**\n   * Configure le gestionnaire de consentement\n   * @param {Object} config - Configuration du consentement\n   */\n  setConfig(config) {\n    this.config = {\n      enabled: config?.enabled !== false, // Par défaut true\n      title: config?.title || \"Votre avis nous intéresse\",\n      description: config?.description || \"Nous aimerions recueillir vos retours pour améliorer votre expérience.\",\n      learnMoreText: config?.learnMoreText || \"En savoir plus\",\n      learnMoreUrl: config?.learnMoreUrl || null,\n      dataCollectionInfo: config?.dataCollectionInfo || \"Nous collectons vos réponses de manière anonyme pour améliorer nos services. Vos données ne seront jamais partagées avec des tiers.\",\n      acceptLabel: config?.acceptLabel || \"Oui, j'accepte\",\n      declineLabel: config?.declineLabel || \"Non merci\",\n      privacyPolicyUrl: config?.privacyPolicyUrl || null,\n    };\n\n    if (ErrorHandler.debugMode) {\n      console.log('[ConsentManager] Configuration mise à jour:', this.config);\n    }\n  }\n\n  /**\n   * Vérifie si le consentement est requis\n   * @returns {boolean} - True si le consentement doit être demandé\n   */\n  isConsentRequired() {\n    try {\n      // Si le consentement est désactivé, pas besoin de le demander\n      if (!this.config || !this.config.enabled) {\n        return false;\n      }\n\n      // Vérifier si le consentement a déjà été donné ou refusé\n      const consentStatus = this.storageManager.getConsent();\n      \n      // Si aucun consentement enregistré, on doit le demander\n      return consentStatus === null;\n\n    } catch (error) {\n      ErrorHandler.log(error, 'ConsentManager.isConsentRequired');\n      return false;\n    }\n  }\n\n  /**\n   * Vérifie si l'utilisateur a donné son consentement\n   * @returns {boolean} - True si l'utilisateur a consenti\n   */\n  hasConsent() {\n    try {\n      // Si le consentement est désactivé, considérer comme accordé\n      if (!this.config || !this.config.enabled) {\n        return true;\n      }\n\n      const consentStatus = this.storageManager.getConsent();\n      return consentStatus === true;\n\n    } catch (error) {\n      ErrorHandler.log(error, 'ConsentManager.hasConsent');\n      return false;\n    }\n  }\n\n  /**\n   * Enregistre le consentement de l'utilisateur\n   * @param {boolean} accepted - True si accepté, false si refusé\n   */\n  saveConsent(accepted) {\n    try {\n      this.storageManager.setConsent(accepted);\n\n      if (ErrorHandler.debugMode) {\n        console.log(`[ConsentManager] Consentement ${accepted ? 'accepté' : 'refusé'}`);\n      }\n\n      // Si refusé, effacer toutes les données collectées (conformité RGPD)\n      if (!accepted) {\n        this.storageManager.clearAllResponses();\n        this.storageManager.clearAllImpressions();\n        \n        if (ErrorHandler.debugMode) {\n          console.log('[ConsentManager] Données utilisateur effacées (refus de consentement)');\n        }\n      }\n\n    } catch (error) {\n      ErrorHandler.log(error, 'ConsentManager.saveConsent');\n    }\n  }\n\n  /**\n   * Réinitialise le consentement (pour permettre à l'utilisateur de le modifier)\n   */\n  resetConsent() {\n    try {\n      this.storageManager.clearConsent();\n      \n      if (ErrorHandler.debugMode) {\n        console.log('[ConsentManager] Consentement réinitialisé');\n      }\n\n    } catch (error) {\n      ErrorHandler.log(error, 'ConsentManager.resetConsent');\n    }\n  }\n\n  /**\n   * Récupère la configuration du consentement\n   * @returns {Object} - Configuration du consentement\n   */\n  getConfig() {\n    return this.config;\n  }\n\n  /**\n   * Récupère le statut actuel du consentement\n   * @returns {Object} - { enabled, required, hasConsent, status }\n   */\n  getStatus() {\n    try {\n      const status = this.storageManager.getConsent();\n      \n      return {\n        enabled: this.config?.enabled || false,\n        required: this.isConsentRequired(),\n        hasConsent: this.hasConsent(),\n        status: status // null, true, ou false\n      };\n\n    } catch (error) {\n      ErrorHandler.log(error, 'ConsentManager.getStatus');\n      return {\n        enabled: false,\n        required: false,\n        hasConsent: true,\n        status: null\n      };\n    }\n  }\n}\n\nexport default ConsentManager;\n","/**\n * PulserSDK - Classe principale du SDK\n * Point d'entrée et orchestration de tous les modules\n */\nimport ErrorHandler from './ErrorHandler.js';\nimport StorageManager from './StorageManager.js';\nimport ConfigManager from './ConfigManager.js';\nimport DecisionEngine from './DecisionEngine.js';\nimport DataSubmitter from './DataSubmitter.js';\nimport NavigationMonitor from './NavigationMonitor.js';\nimport UIRenderer from './UIRenderer.js';\nimport ConsentManager from './ConsentManager.js';\n\nclass PulserSDK {\n  // Instance statique pour le pattern Singleton\n  static instance = null;\n\n  constructor() {\n    // Vérifier si une instance existe déjà (Singleton)\n    if (PulserSDK.instance) {\n      if (ErrorHandler.debugMode) {\n        console.warn('[PulserSDK] Instance already exists, returning existing instance');\n      }\n      return PulserSDK.instance;\n    }\n\n    // Configuration\n    this.domain = null;\n    this.language = 'en';\n    this.specificId = null;\n    this.debugMode = false;\n    this.position = 'bottom-right';\n    \n    // Modules\n    this.storageManager = null;\n    this.configManager = null;\n    this.decisionEngine = null;\n    this.dataSubmitter = null;\n    this.navigationMonitor = null;\n    this.uiRenderer = null;\n    this.consentManager = null;\n    \n    // État\n    this.isInitialized = false;\n    this.campaigns = [];\n    this.currentCampaign = null; // Campagne actuellement affichée\n    this.currentQuestion = null; // Question actuellement affichée\n    this.pollingInterval = 2000; // 2 secondes par défaut\n    \n    // Protection contre affichages multiples\n    this.isDisplaying = false; // Flag pour éviter affichages simultanés\n    this.lastTriggerTime = 0; // Timestamp du dernier déclenchement\n    this.debounceDelay = 500; // Délai minimum entre deux déclenchements (ms)\n\n    // Stocker l'instance\n    PulserSDK.instance = this;\n  }\n\n  /**\n   * Initialisation du SDK\n   * @param {string} domain - Domaine de l'API (ex: 'example.com')\n   * @param {string} language - Langue (ex: 'fr', 'en')\n   * @param {string|null} specificId - ID spécifique optionnel\n   * @param {Object} options - Options additionnelles\n   */\n  async init(domain, language = 'en', specificId = null, options = {}) {\n    if (this.isInitialized) {\n      console.warn('[PulserSDK] Already initialized');\n      return;\n    }\n\n    // Configuration\n    this.domain = domain;\n    this.language = language;\n    this.specificId = specificId;\n    this.debugMode = options.debug || false;\n    this.pollingInterval = options.pollingInterval || 2000;\n    this.position = options.position || 'bottom-right';\n\n    // Active le mode debug si demandé\n    if (this.debugMode) {\n      ErrorHandler.enableDebug();\n    }\n\n    // Initialisation avec gestion d'erreur\n    await ErrorHandler.wrap(async () => {\n      if (ErrorHandler.debugMode) {\n        console.log('[PulserSDK] Initializing...', {\n          domain,\n          language,\n          specificId,\n          debug: this.debugMode\n        });\n      }\n\n      this._setupModules();\n      await this._fetchConfiguration();\n      this._startMonitoring();\n      \n      this.isInitialized = true;\n\n      if (ErrorHandler.debugMode) {\n        console.log('[PulserSDK] Initialized successfully', {\n          campaignsCount: this.campaigns.length\n        });\n      }\n    }, 'init')();\n  }\n\n  /**\n   * Initialise tous les modules internes\n   */\n  _setupModules() {\n    // Storage\n    this.storageManager = new StorageManager();\n    \n    // Config\n    this.configManager = new ConfigManager(\n      this.domain,\n      this.language,\n      this.specificId,\n      this.storageManager\n    );\n    \n    // Décision\n    this.decisionEngine = new DecisionEngine(this.storageManager);\n    \n    // Data\n    this.dataSubmitter = new DataSubmitter(this.domain);\n    \n    // UI\n    this.uiRenderer = new UIRenderer(\n      this._handleSubmit.bind(this),\n      this._handleDismiss.bind(this),\n      this.position\n    );\n    \n    // Navigation\n    this.navigationMonitor = new NavigationMonitor(\n      this._handlePageChange.bind(this)\n    );\n\n    // Consent\n    this.consentManager = new ConsentManager(this.storageManager);\n\n    if (ErrorHandler.debugMode) {\n      console.log('[PulserSDK] Modules initialized');\n    }\n  }\n\n  /**\n   * Charge la configuration depuis l'API (avec cache)\n   */\n  async _fetchConfiguration() {\n    const config = await this.configManager.fetchConfig();\n    this.campaigns = config.campaigns || [];\n    \n    // Configurer le consentement\n    if (config.consent) {\n      this.consentManager.setConfig(config.consent);\n    } else {\n      // Configuration par défaut si non fournie\n      this.consentManager.setConfig({\n        enabled: true\n      });\n    }\n    \n    if (ErrorHandler.debugMode) {\n      console.log('[PulserSDK] Configuration loaded:', {\n        campaignsCount: this.campaigns.length,\n        campaigns: this.campaigns.map(c => ({\n          id: c.id,\n          name: c.name,\n          priority: c.priority,\n          questionsCount: c.questions?.length || 0\n        })),\n        consentStatus: this.consentManager.getStatus()\n      });\n    }\n  }\n\n  /**\n   * Démarre la surveillance de navigation\n   */\n  _startMonitoring() {\n    // Démarrer le monitor avec l'intervalle configuré\n    this.navigationMonitor.start(this.pollingInterval);\n    \n    // Évaluation initiale au chargement\n    this._handlePageChange(window.location.href);\n  }\n\n  /**\n   * Callback appelé à chaque changement de page\n   * @param {string} url - Nouvelle URL\n   */\n  _handlePageChange(url) {\n    ErrorHandler.wrap(() => {\n      // Debounce : Éviter plusieurs déclenchements rapides\n      const now = Date.now();\n      if (now - this.lastTriggerTime < this.debounceDelay) {\n        if (ErrorHandler.debugMode) {\n          console.log('[PulserSDK] Debounced: Too soon after last trigger');\n        }\n        return;\n      }\n\n      // Vérifier si une question est déjà en cours d'affichage\n      if (this.isDisplaying) {\n        if (ErrorHandler.debugMode) {\n          console.log('[PulserSDK] Already displaying a question, skipping');\n        }\n        return;\n      }\n\n      if (ErrorHandler.debugMode) {\n        console.log('[PulserSDK] Page change detected:', url);\n      }\n\n      const processNewPage = () => {\n        // Marquer comme en cours d'affichage\n        this.isDisplaying = true;\n        this.lastTriggerTime = now;\n\n        // Vérifier le consentement RGPD\n        if (this.consentManager.isConsentRequired()) {\n          // Afficher l'écran de consentement\n          if (ErrorHandler.debugMode) {\n            console.log('[PulserSDK] Consent required, showing consent screen');\n          }\n          \n          const consentConfig = this.consentManager.getConfig();\n          this.uiRenderer.renderConsent(consentConfig, (accepted) => {\n            this.consentManager.saveConsent(accepted);\n            \n            if (accepted) {\n              // Consentement accepté, continuer avec la question\n              this._showNextQuestion(url);\n            } else {\n              // Consentement refusé, masquer et libérer\n              this.uiRenderer.hide();\n              this.isDisplaying = false;\n            }\n          });\n          this.uiRenderer.show();\n          return;\n        }\n\n        // Vérifier si l'utilisateur a consenti\n        if (!this.consentManager.hasConsent()) {\n          if (ErrorHandler.debugMode) {\n            console.log('[PulserSDK] No consent given, skipping questions');\n          }\n          this.isDisplaying = false;\n          return;\n        }\n\n        // Afficher la question\n        this._showNextQuestion(url);\n      };\n\n      // Si un widget est déjà visible, on le ferme d'abord (transition 300ms)\n      if (this.uiRenderer.isVisible) {\n        if (ErrorHandler.debugMode) {\n          console.log('[PulserSDK] Closing widget due to navigation');\n        }\n        this.uiRenderer.hide();\n        setTimeout(processNewPage, 350);\n      } else {\n        processNewPage();\n      }\n    }, 'handlePageChange')();\n  }\n\n  /**\n   * Affiche la prochaine question éligible\n   * @param {string} url - URL courante\n   * @private\n   */\n  _showNextQuestion(url) {\n    // Trouver une campagne éligible\n    const result = this.decisionEngine.findEligibleCampaign(\n      this.campaigns,\n      url\n    );\n\n    if (result) {\n      if (ErrorHandler.debugMode) {\n        console.log('[PulserSDK] Eligible campaign found:', {\n          campaignId: result.campaign.id,\n          questionId: result.question.id\n        });\n      }\n      \n      this.currentCampaign = result.campaign;\n      this.currentQuestion = result.question;\n      \n      this.uiRenderer.renderQuestion(result.question, result.campaign);\n      this.uiRenderer.show();\n      \n      // Marquer la campagne comme affichée\n      this.storageManager.markCampaignAsShown(\n        result.campaign.id,\n        result.question.id\n      );\n    } else {\n      if (ErrorHandler.debugMode) {\n        console.log('[PulserSDK] No eligible campaign for this page');\n      }\n      // Libérer le flag si aucune question trouvée\n      this.isDisplaying = false;\n    }\n  }\n\n  /**\n   * Gestion de la soumission d'une réponse\n   * @param {string} questionId - ID de la question\n   * @param {any} answer - Réponse de l'utilisateur\n   */\n  _handleSubmit(questionId, answer) {\n    ErrorHandler.wrap(async () => {\n      if (!this.currentCampaign) {\n        console.warn('[PulserSDK] No current campaign');\n        return;\n      }\n\n      if (ErrorHandler.debugMode) {\n        console.log('[PulserSDK] Answer submitted:', {\n          campaignId: this.currentCampaign.id,\n          questionId,\n          answer\n        });\n      }\n\n      // Envoi de la réponse\n      await this.dataSubmitter.submitAnswer(\n        this.currentCampaign.id,\n        questionId,\n        answer,\n        this.storageManager.getAllUserData()\n      );\n      \n      // Marquer la campagne comme answered avec le couple (campaignId, questionId)\n      this.storageManager.markCampaignAsAnswered(this.currentCampaign.id, questionId);\n\n      // Libérer le flag d'affichage\n      this.isDisplaying = false;\n\n      if (ErrorHandler.debugMode) {\n        console.log('[PulserSDK] Answer sent successfully, display flag released');\n      }\n    }, 'handleSubmit')();\n  }\n\n  /**\n   * Gestion de la fermeture manuelle (dismiss)\n   * @param {string} questionId - ID de la question\n   */\n  _handleDismiss(questionId) {\n    ErrorHandler.wrap(async () => {\n      if (!this.currentCampaign) {\n        console.warn('[PulserSDK] No current campaign');\n        return;\n      }\n\n      if (ErrorHandler.debugMode) {\n        console.log('[PulserSDK] Question dismissed:', {\n          campaignId: this.currentCampaign.id,\n          questionId\n        });\n      }\n\n      // Envoi de l'impression\n      await this.dataSubmitter.submitImpression(\n        this.currentCampaign.id,\n        questionId,\n        this.storageManager.getAllUserData()\n      );\n      \n      // Marquer la campagne comme dismissed\n      this.storageManager.markCampaignAsDismissed(this.currentCampaign.id);\n\n      // Libérer le flag d'affichage\n      this.isDisplaying = false;\n\n      if (ErrorHandler.debugMode) {\n        console.log('[PulserSDK] Impression sent successfully, display flag released');\n      }\n    }, 'handleDismiss')();\n  }\n\n  // ========== API PUBLIQUE ==========\n\n  /**\n   * Force l'affichage d'une campagne spécifique\n   * @param {string} campaignId - ID de la campagne à afficher\n   */\n  showCampaign(campaignId) {\n    if (!this.isInitialized) {\n      console.warn('[PulserSDK] Not initialized. Call init() first.');\n      return;\n    }\n\n    ErrorHandler.wrap(() => {\n      // Réinitialiser le flag pour permettre l'affichage forcé\n      this.isDisplaying = false;\n\n      const campaign = this.campaigns.find(c => c.id === campaignId);\n      \n      if (campaign && campaign.questions && campaign.questions.length > 0) {\n        if (ErrorHandler.debugMode) {\n          console.log('[PulserSDK] Forcing display of campaign:', campaignId);\n        }\n        \n        // Sélectionner une question non-répondue ou aléatoire si toutes répondues\n        const unansweredQuestions = campaign.questions.filter(q => \n          !this.storageManager.hasAnswered(campaign.id, q.id)\n        );\n        \n        const questionsToChooseFrom = unansweredQuestions.length > 0 \n          ? unansweredQuestions \n          : campaign.questions;\n        \n        const randomIndex = Math.floor(Math.random() * questionsToChooseFrom.length);\n        const question = questionsToChooseFrom[randomIndex];\n        \n        this.currentCampaign = campaign;\n        this.currentQuestion = question;\n        this.isDisplaying = true;\n        \n        this.uiRenderer.renderQuestion(question, campaign);\n        this.uiRenderer.show();\n        \n        this.storageManager.markCampaignAsShown(campaign.id, question.id);\n      } else {\n        console.warn(`[PulserSDK] Campaign not found or has no questions: ${campaignId}`);\n      }\n    }, 'showCampaign')();\n  }\n\n  /**\n   * Force l'affichage d'une question spécifique (pour compatibilité)\n   * Recherche la question dans toutes les campagnes\n   * @param {string} questionId - ID de la question à afficher\n   */\n  showQuestion(questionId) {\n    if (!this.isInitialized) {\n      console.warn('[PulserSDK] Not initialized. Call init() first.');\n      return;\n    }\n\n    ErrorHandler.wrap(() => {\n      // Réinitialiser le flag pour permettre l'affichage forcé\n      this.isDisplaying = false;\n\n      // Rechercher la question dans toutes les campagnes\n      for (const campaign of this.campaigns) {\n        if (campaign.questions) {\n          const question = campaign.questions.find(q => q.id === questionId);\n          if (question) {\n            if (ErrorHandler.debugMode) {\n              console.log('[PulserSDK] Forcing display of question:', {\n                campaignId: campaign.id,\n                questionId\n              });\n            }\n            \n            this.currentCampaign = campaign;\n            this.currentQuestion = question;\n            this.isDisplaying = true;\n            \n            this.uiRenderer.renderQuestion(question, campaign);\n            this.uiRenderer.show();\n            \n            this.storageManager.markCampaignAsShown(campaign.id, question.id);\n            return;\n          }\n        }\n      }\n      \n      // Debug: afficher toutes les questions disponibles\n      if (ErrorHandler.debugMode) {\n        const allQuestions = [];\n        this.campaigns.forEach(c => {\n          if (c.questions) {\n            c.questions.forEach(q => allQuestions.push({ campaignId: c.id, questionId: q.id, type: q.type }));\n          }\n        });\n        console.warn(`[PulserSDK] Question not found: ${questionId}`);\n        console.log('[PulserSDK] Available questions:', allQuestions);\n      } else {\n        console.warn(`[PulserSDK] Question not found: ${questionId}`);\n      }\n    }, 'showQuestion')();\n  }\n\n  /**\n   * Enrichit les métadonnées utilisateur\n   * @param {Object} userData - Données utilisateur (ex: {id: '123', email: 'user@example.com'})\n   */\n  setUserInfo(userData) {\n    if (!this.isInitialized) {\n      console.warn('[PulserSDK] Not initialized. Call init() first.');\n      return;\n    }\n\n    ErrorHandler.wrap(() => {\n      if (typeof userData !== 'object' || userData === null) {\n        console.warn('[PulserSDK] setUserInfo expects an object');\n        return;\n      }\n\n      // Vérification de sécurité : détecter les objets problématiques\n      if (userData === window || userData === document) {\n        console.error('[PulserSDK] Cannot use window or document as user data');\n        return;\n      }\n\n      Object.entries(userData).forEach(([key, value]) => {\n        // Vérifier aussi les valeurs individuelles\n        if (value === window || value === document) {\n          console.warn(`[PulserSDK] Skipping key \"${key}\": cannot store window or document references`);\n          return;\n        }\n        this.storageManager.setUserData(key, value);\n      });\n\n      if (ErrorHandler.debugMode) {\n        console.log('[PulserSDK] User info updated:', userData);\n      }\n    }, 'setUserInfo')();\n  }\n\n  /**\n   * Cache le widget actuellement affiché\n   */\n  hide() {\n    if (this.uiRenderer) {\n      this.uiRenderer.hide();\n      // Libérer le flag d'affichage\n      this.isDisplaying = false;\n    }\n  }\n\n  /**\n   * Affiche le widget (si une question est déjà rendue)\n   */\n  show() {\n    if (this.uiRenderer && this.uiRenderer.currentQuestion) {\n      this.uiRenderer.show();\n    }\n  }\n\n  /**\n   * Force une réévaluation immédiate (utile après navigation manuelle)\n   */\n  refresh() {\n    if (!this.isInitialized) return;\n    \n    this.navigationMonitor.checkNow();\n  }\n\n  /**\n   * Change la position du widget sans réinitialiser le SDK\n   * @param {string} newPosition - Nouvelle position (ex: 'bottom-center')\n   */\n  updatePosition(newPosition) {\n    if (!this.isInitialized) {\n      console.warn('[PulserSDK] SDK not initialized');\n      return;\n    }\n\n    ErrorHandler.wrap(() => {\n      // Sauvegarder l'état actuel\n      const wasDisplaying = this.isDisplaying;\n      const currentQ = this.currentQuestion;\n      const currentC = this.currentCampaign;\n\n      // Détruire l'UI actuelle\n      if (this.uiRenderer) {\n        this.uiRenderer.destroy();\n      }\n\n      // Créer un nouveau renderer avec la nouvelle position\n      this.position = newPosition;\n      this.uiRenderer = new UIRenderer(\n        this._handleSubmit.bind(this),\n        this._handleDismiss.bind(this),\n        newPosition\n      );\n\n      // Restaurer l'état si une question était affichée\n      if (wasDisplaying && currentQ && currentC) {\n        this.currentQuestion = currentQ;\n        this.currentCampaign = currentC;\n        this.uiRenderer.renderQuestion(currentQ, currentC);\n        this.uiRenderer.show();\n        this.isDisplaying = true;\n      }\n\n      if (ErrorHandler.debugMode) {\n        console.log('[PulserSDK] Position updated to:', newPosition);\n      }\n    }, 'updatePosition')();\n  }\n\n  /**\n   * Détruit complètement le SDK\n   */\n  destroy() {\n    if (!this.isInitialized) return;\n\n    ErrorHandler.wrap(() => {\n      // Arrêter la surveillance\n      if (this.navigationMonitor) {\n        this.navigationMonitor.stop();\n      }\n      \n      // Détruire l'UI\n      if (this.uiRenderer) {\n        this.uiRenderer.destroy();\n      }\n      \n      // Reset l'état\n      this.isInitialized = false;\n      this.campaigns = [];\n      this.currentCampaign = null;\n      this.currentQuestion = null;\n      this.isDisplaying = false;\n\n      // Supprimer l'instance singleton\n      PulserSDK.instance = null;\n\n      if (ErrorHandler.debugMode) {\n        console.log('[PulserSDK] Destroyed');\n      }\n    }, 'destroy')();\n  }\n\n  /**\n   * Efface toutes les données du SDK (cache, fréquences, etc.)\n   */\n  clearData() {\n    if (this.storageManager) {\n      this.storageManager.clearAll();\n      \n      if (ErrorHandler.debugMode) {\n        console.log('[PulserSDK] All data cleared');\n      }\n    }\n  }\n\n  // ========== Méthodes de gestion du consentement RGPD ==========\n\n  /**\n   * Récupère le statut actuel du consentement\n   * @returns {Object} - { enabled, required, hasConsent, status }\n   */\n  getConsentStatus() {\n    if (!this.consentManager) {\n      return {\n        enabled: false,\n        required: false,\n        hasConsent: true,\n        status: null\n      };\n    }\n    return this.consentManager.getStatus();\n  }\n\n  /**\n   * Vérifie si l'utilisateur a donné son consentement\n   * @returns {boolean}\n   */\n  hasConsent() {\n    if (!this.consentManager) return true;\n    return this.consentManager.hasConsent();\n  }\n\n  /**\n   * Réinitialise le consentement (pour permettre de le redemander)\n   * Utile pour les paramètres utilisateur ou les tests\n   */\n  resetConsent() {\n    if (!this.consentManager) return;\n    \n    ErrorHandler.wrap(() => {\n      this.consentManager.resetConsent();\n      \n      if (ErrorHandler.debugMode) {\n        console.log('[PulserSDK] Consent reset');\n      }\n    }, 'resetConsent')();\n  }\n\n  /**\n   * Définit manuellement le consentement (pour une intégration externe)\n   * @param {boolean} accepted - true si accepté, false si refusé\n   */\n  setConsent(accepted) {\n    if (!this.consentManager) return;\n    \n    ErrorHandler.wrap(() => {\n      this.consentManager.saveConsent(accepted);\n      \n      if (ErrorHandler.debugMode) {\n        console.log('[PulserSDK] Consent manually set:', accepted);\n      }\n    }, 'setConsent')();\n  }\n\n  /**\n   * Recharge la configuration depuis l'API (force un refresh)\n   * @returns {Promise<void>}\n   */\n  async reloadConfig() {\n    if (!this.isInitialized) {\n      console.warn('[PulserSDK] Not initialized. Call init() first.');\n      return;\n    }\n\n    return ErrorHandler.wrap(async () => {\n      if (ErrorHandler.debugMode) {\n        console.log('[PulserSDK] Reloading configuration...');\n      }\n\n      // Forcer le rechargement en ignorant le cache\n      this.campaigns = await this.configManager.fetchCampaigns(true);\n      \n      if (ErrorHandler.debugMode) {\n        console.log('[PulserSDK] Configuration reloaded:', {\n          campaignsCount: this.campaigns.length,\n          campaigns: this.campaigns.map(c => ({ id: c.id, name: c.name, questionsCount: c.questions?.length || 0 }))\n        });\n      }\n    }, 'reloadConfig')();\n  }\n\n  /**\n   * Récupère les informations de debug\n   * @returns {Object}\n   */\n  getDebugInfo() {\n    return {\n      isInitialized: this.isInitialized,\n      domain: this.domain,\n      language: this.language,\n      specificId: this.specificId,\n      debugMode: this.debugMode,\n      campaignsCount: this.campaigns.length,\n      campaigns: this.campaigns.map(c => ({\n        id: c.id,\n        name: c.name,\n        priority: c.priority,\n        frequencyDays: c.frequencyDays,\n        luckFactor: c.luckFactor,\n        questionsCount: c.questions?.length || 0,\n        canShow: this.storageManager.canShowCampaign(c.id, c.frequencyDays || 0)\n      })),\n      currentCampaign: this.currentCampaign ? {\n        id: this.currentCampaign.id,\n        name: this.currentCampaign.name\n      } : null,\n      currentQuestion: this.currentQuestion ? {\n        id: this.currentQuestion.id,\n        title: this.currentQuestion.title\n      } : null,\n      currentUrl: window.location.href,\n      isWidgetVisible: this.uiRenderer?.isVisible || false,\n      isDisplaying: this.isDisplaying,\n      lastTriggerTime: this.lastTriggerTime,\n      userData: this.storageManager?.getAllUserData() || {}\n    };\n  }\n\n  /**\n   * Méthode statique pour obtenir l'instance singleton\n   * @returns {PulserSDK|null}\n   */\n  static getInstance() {\n    return PulserSDK.instance;\n  }\n}\n\nexport default PulserSDK;\n","/**\n * Point d'entrée du SDK Pulser\n * Expose l'instance globale sur window\n */\nimport PulserSDK from './PulserSDK.js';\n\n// Auto-initialisation : exposition sur window\n(function() {\n  if (typeof window !== 'undefined') {\n    // Créer une instance unique\n    const sdkInstance = new PulserSDK();\n    \n    // Exposer sur window\n    window.PulserSDK = sdkInstance;\n    \n    // Log en mode développement\n    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {\n      console.log('[PulserSDK] SDK loaded and ready. Usage:');\n      console.log('  window.PulserSDK.init(\"your-domain.com\", \"fr\", null, { debug: true })');\n    }\n  }\n})();\n\n// Export pour utilisation en module\nexport default PulserSDK;\n"],"names":["ErrorHandler","static","wrap","fn","context","async","args","error","log","debugMode","window","location","hostname","console","warn","enableDebug","disableDebug","StorageManager","constructor","this","prefix","keys","userMeta","campaignHistory","answeredQuestions","configCache","configLastFetch","consent","_sanitizeValue","value","seen","WeakSet","Element","Node","nodeName","document","has","add","Array","isArray","map","item","sanitized","key","hasOwnProperty","err","setUserData","userData","getAllUserData","sanitizedValue","sanitizedUserData","localStorage","setItem","JSON","stringify","data","getItem","parse","getCampaignHistory","campaignId","_getAllCampaignHistory","markCampaignAsShown","questionId","history","now","Date","lastShown","shownCount","lastQuestionId","firstShown","dismissedCount","answeredCount","sanitizedHistory","markCampaignAsDismissed","markCampaignAsAnswered","_storeAnsweredQuestion","canShowCampaign","frequencyDays","daysSinceLastShown","canShow","toFixed","answered","_getAllAnsweredQuestions","sanitizedAnswered","hasAnswered","undefined","setCachedConfig","config","sanitizedConfig","toString","getCachedConfig","getLastFetchDate","date","parseInt","isCacheValid","ttl","lastFetch","getConsent","setConsent","accepted","clearConsent","removeItem","clearAllResponses","clearAllImpressions","clearAll","Object","values","forEach","ConfigManager","domain","language","specificId","storageManager","apiBaseUrl","fetchConfig","forceRefresh","cachedConfig","cacheTTL","_fetchFromAPI","campaigns","fetchCampaigns","url","_buildApiUrl","headers","_buildHeaders","response","fetch","method","cache","status","ok","json","campaignsCount","length","Accept","lastFetchDate","DecisionEngine","findEligibleCampaign","currentUrl","activeCampaigns","filter","campaign","isActive","startDate","endDate","id","toISOString","urlEligibleCampaigns","_isUrlEligible","frequencyEligibleCampaigns","sortedCampaigns","sort","a","b","priority","luckFactor","random","Math","passes","selectedQuestion","_selectQuestionFromCampaign","question","path","URL","pathname","blockListRegex","pattern","RegExp","test","allowListRegex","questions","unansweredQuestions","floor","totalQuestions","DataSubmitter","_sanitizeData","obj","e","submitAnswer","answer","metadata","payload","timestamp","href","userAgent","navigator","sanitizedPayload","body","submitImpression","NavigationMonitor","onNavigate","listeners","pollingInterval","start","pollingIntervalMs","_listenToNativeEvents","_startPolling","stop","target","event","handler","options","removeEventListener","clearInterval","popStateHandler","_checkUrlChange","addEventListener","push","hashChangeHandler","clickHandler","link","closest","setTimeout","submitHandler","interval","setInterval","newUrl","from","to","checkNow","ValidationManager","validate","type","responseConfig","validation","errors","valid","_validateTextarea","_validateSelect","_validateNumeric","_validateBoolean","_validateGeneric","custom","customResult","required","requiredMessage","text","String","minLength","minLengthMessage","maxLength","maxLengthMessage","patternMessage","forbiddenWords","lowerText","toLowerCase","foundForbidden","word","includes","forbiddenWordsMessage","join","forbiddenValues","forbiddenValuesMessage","num","Number","min","minMessage","max","maxMessage","mustBeTrue","mustBeTrueMessage","mustBeFalse","mustBeFalseMessage","validateLive","UIRenderer","onSubmit","onDismiss","position","shadowHost","shadowRoot","isVisible","currentQuestion","createShadowContainer","existingHost","getElementById","parentNode","removeChild","createElement","setAttribute","attachShadow","mode","styleSheet","textContent","_getStyles","appendChild","container","className","renderQuestion","currentCampaign","innerHTML","_generateQuestionHTML","_attachEventListeners","renderConsent","consentConfig","onConsent","_generateConsentHTML","_attachConsentEventListeners","show","classList","remove","hide","destroy","shouldAutoSubmit","_shouldAutoSubmit","_escapeHtml","title","assistiveText","_generateInputField","_renderTextarea","_renderRating","_renderBoolean","_renderNPS","_renderScale","_renderSelect","maxChars","placeholder","labels","html","i","yesLabel","noLabel","minLabel","maxLabel","allowCustom","option","label","form","closeBtn","preventDefault","_submitAnswer","textarea","querySelector","charCurrent","trim","validationResult","_clearValidationErrors","_showValidationErrors","select","customInput","focus","_attachAutoSubmitListeners","_attachRatingHoverEffect","ratingInputs","querySelectorAll","ratingStars","input","index","star","ratingContainer","_extractAnswer","rating","bool","nps","scale","requireSubmitButton","_showThankYouMessage","thankYouConfig","thankYouMessage","enabled","messageText","randomIndex","totalMessages","selectedMessage","message","duration","widget","wasArray","errorContainer","insertBefore","firstChild","description","learnMoreUrl","learnMoreText","dataCollectionInfo","privacyPolicyUrl","acceptLabel","declineLabel","closeButton","acceptButton","declineButton","div","_getPositionConfig","margin","configs","css","hidden","visible","center","posConfig","ConsentManager","setConfig","isConsentRequired","hasConsent","saveConsent","resetConsent","getConfig","getStatus","PulserSDK","instance","configManager","decisionEngine","dataSubmitter","navigationMonitor","uiRenderer","consentManager","isInitialized","isDisplaying","lastTriggerTime","debounceDelay","init","debug","_setupModules","_fetchConfiguration","_startMonitoring","_handleSubmit","bind","_handleDismiss","_handlePageChange","c","name","questionsCount","consentStatus","processNewPage","_showNextQuestion","result","showCampaign","find","q","questionsToChooseFrom","showQuestion","allQuestions","setUserInfo","entries","refresh","updatePosition","newPosition","wasDisplaying","currentQ","currentC","clearData","getConsentStatus","reloadConfig","getDebugInfo","isWidgetVisible","getInstance","sdkInstance"],"mappings":"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"}